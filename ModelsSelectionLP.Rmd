---
title: "Models Selection"
author: "Loïc Pages"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  word_document: default
---

# Introduction
note: comperse survie/age

```{r}
rm(list=ls())
library(knitr)
library(spaMM)
library(tidyverse)

setwd("/media/loic/Commun/0Travail/Stage 2025 ISEM/Models")

data <- read.csv("donnesIPM_short.csv")


#Supprimer plantes dont l'age est inconnu
data <- data[!is.na(data$age0), ]
data$age1 <- ifelse(data$Stage1=="V",data$age0+1,NA)

#Forcer l'age maximal à 8
AgeMax <- 8
length(data$age0[data$age0 >= AgeMax])
data$age0[data$age0 > AgeMax] <- AgeMax
  
#Ajouter la taille au carré
data$s2 <- data$Size0Mars ** 2
data$a2 <- data$age0 **2
data$s3 <- data$Size0Mars ** 3

spaMM.options(separation_max=70)
```

# Modèles

Modèle IPM
$$N(y,t+1)=\int N(x,t)(F_a(x,y,t)+P_a(x,y,t))dx$$
avec $x$ la taille à $t$, $y$ la taille à $t+1$, $a$ l'age et $N$ la taille de la population

La probabilité qu'un individu d'age a et de taille x au temps t devienne un individu d'age a+1 et de taille y à t+1 est :
$$P_a(x,y,t)=s_a(x)(1-f_a(x))G_a(x,y)$$
et la densité d'individus de taille y à t et d'age 1 (plantules) issus d'un individu de taille x et d'age a à t est :
$$F_a(x,y,t)=f_a(x)C_a(x)w(y)Estb$$
# Sélection du modèle

## Nombre de capitules / Fécondité

```{r}
cptldata <- data[!is.na(data$Cptl0),]
cptldata <- cptldata[cptldata$Flowering0!=0,]

length(cptldata[is.na(cptldata$Cptl0),])

ggplot(data=cptldata,aes(x=Size0Mars,y=Cptl0))+
  geom_point()+
  geom_smooth()

ggplot(data=cptldata,aes(x=year,y=Cptl0))+
  geom_smooth()+
  geom_point()

ggplot(data=cptldata,aes(x=Pop,y=Cptl0))+
  geom_point()
```

```{r}
Cptlglm1=fitme(Cptl0 ~ 1+Size0Mars+age0 ,data=cptldata)

Cptlglm2=fitme(Cptl0 ~ 1+Size0Mars + s2 +age0 ,data=cptldata)


Cptlglm2=fitme(Cptl0 ~ poly(Size0Mars,2) + age0+(1+poly(Size0Mars,2) + age0|year) + (1+poly(Size0Mars,2) + age0|Pop), data=cptldata)

Cptlglm3=fitme(Cptl0 ~ poly(Size0Mars,2) + age0+(1+poly(Size0Mars,2) + age0|year) + (1+poly(Size0Mars,2) + age0|Pop)+ (1+poly(Size0Mars,2) + age0|Pop:year), data=cptldata)

rbind(extractAIC(Cptlglm1),extractAIC(Cptlglm2))

```

test de la pertinence des variables dans l'intéraction Pop:year
```{r}
# Cptlglm1=fitme(Cptl0 ~ poly(Size0Mars,2) + age0+(1+poly(Size0Mars,2) + age0|year) + (1+poly(Size0Mars,2) + age0|Pop)+ (1+poly(Size0Mars,2) + age0|Pop:year), data=cptldata)
Cptlglm1=fitme(Cptl0 ~ poly(Size0Mars,2) + age0+(1+poly(Size0Mars,2) + age0|year) + (1+poly(Size0Mars,2) + age0|Pop)+ (1+poly(Size0Mars,2)|Pop:year), data=cptldata)
Cptlglm2=fitme(Cptl0 ~ poly(Size0Mars,2) + age0+(1+poly(Size0Mars,2) + age0|year) + (1+poly(Size0Mars,2) + age0|Pop)+ (1+Size0Mars + age0|Pop:year), data=cptldata)
Cptlglm4=fitme(Cptl0 ~ poly(Size0Mars,2) + age0+(1+poly(Size0Mars,2) + age0|year) + (1+poly(Size0Mars,2) + age0|Pop)+ (1+ s2 + age0|Pop:year), data=cptldata)
Cptlglm5=fitme(Cptl0 ~ poly(Size0Mars,2) + age0+(1+poly(Size0Mars,2) + age0|year) + (1+poly(Size0Mars,2) + age0|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)

rbind(extractAIC(Cptlglm3),extractAIC(Cptlglm1),extractAIC(Cptlglm2),extractAIC(Cptlglm4),extractAIC(Cptlglm5))

```

test de la pertinence des variables dans year
```{r}
# Cptlglm3=fitme(Cptl0 ~ poly(Size0Mars,2) + age0+(poly(Size0Mars,2) + age0|year) + (poly(Size0Mars,2) + age0|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)
Cptlglm1=fitme(Cptl0 ~ poly(Size0Mars,2) + age0 + (Size0Mars + age0|year) + (poly(Size0Mars,2) + age0|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)
Cptlglm4=fitme(Cptl0 ~ poly(Size0Mars,2) + age0 + (s2 + age0|year) + (poly(Size0Mars,2) + age0|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)
Cptlglm5=fitme(Cptl0 ~ poly(Size0Mars,2) + age0 + (poly(Size0Mars,2)|year) + (poly(Size0Mars,2) + age0|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)


rbind(extractAIC(Cptlglm3),extractAIC(Cptlglm1),extractAIC(Cptlglm4),extractAIC(Cptlglm5))
```
```{r}
Cptlglm1=fitme(Cptl0 ~ poly(Size0Mars,2) + age0 + (Size0Mars + age0|year) + (poly(Size0Mars,2) + age0|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)
Cptlglm2=fitme(Cptl0 ~ poly(Size0Mars,2) + age0 + (age0|year) + (poly(Size0Mars,2) + age0|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)
Cptlglm3=fitme(Cptl0 ~ poly(Size0Mars,2) + age0 + (Size0Mars |year) + (poly(Size0Mars,2) + age0|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)

rbind(extractAIC(Cptlglm1),extractAIC(Cptlglm2),extractAIC(Cptlglm3))
```
```{r}
Cptlglm1=fitme(Cptl0 ~ poly(Size0Mars,2) + age0 + (Size0Mars |year) + (poly(Size0Mars,2) + age0|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)
Cptlglm2=fitme(Cptl0 ~ poly(Size0Mars,2) + age0 + (Size0Mars |year) + (poly(Size0Mars,2)|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)
Cptlglm3=fitme(Cptl0 ~ poly(Size0Mars,2) + age0 + (Size0Mars |year) + (Size0Mars + age0|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)
Cptlglm4=fitme(Cptl0 ~ poly(Size0Mars,2) + age0 + (Size0Mars |year) + (s2 + age0|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)

rbind(extractAIC(Cptlglm1),extractAIC(Cptlglm2),extractAIC(Cptlglm3),extractAIC(Cptlglm4))

```
```{r}
Cptlglm1=fitme(Cptl0 ~ poly(Size0Mars,2) + (Size0Mars |year) + (poly(Size0Mars,2) + age0|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)
Cptlglm2=fitme(Cptl0 ~ Size0Mars + age0 + (Size0Mars |year) + (poly(Size0Mars,2) + age0|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)

Cptlglm3=fitme(Cptl0 ~ s2 + age0 + (Size0Mars |year) + (poly(Size0Mars,2) + age0|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)

rbind(extractAIC(Cptlglm1),extractAIC(Cptlglm2),extractAIC(Cptlglm3))
```
```{r}
Cptlglm1=fitme(Cptl0 ~ s2 + age0 + (Size0Mars |year) + (poly(Size0Mars,2) + age0|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)

Cptlglm2=fitme(Cptl0 ~ s2 + age0 + (Size0Mars |year) + (poly(Size0Mars,2) + age0|Pop), data=cptldata)

Cptlglm3=fitme(Cptl0 ~ s2 + age0 + (Size0Mars |year) + (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)

Cptlglm4=fitme(Cptl0 ~ s2 + age0 + (poly(Size0Mars,2) + age0|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)

Cptlglm5=fitme(Cptl0 ~ s2 + age0 + (poly(Size0Mars,2) + age0|Pop:year), data=cptldata)

Cptlglm6=fitme(Cptl0 ~ s2 + as.factor(age0) + (poly(Size0Mars,2) + as.factor(age0)|Pop:year), data=cptldata)

rbind(extractAIC(Cptlglm1),extractAIC(Cptlglm2),extractAIC(Cptlglm3),extractAIC(Cptlglm4),extractAIC(Cptlglm5),extractAIC(Cptlglm6))
```

```{r}
Cptlglm6=fitme(Cptl0 ~ Size0Mars + s2 + as.factor(age0) + (poly(Size0Mars,2) + as.factor(age0)|Pop:year), data=cptldata)

Cptlglm7=fitme(Cptl0 ~ Size0Mars, data=cptldata)

rbind(extractAIC(Cptlglm6),extractAIC(Cptlglm7))
```

cptlglm7

modèle choisi :
size
$$c_a(x)=\beta_0+\delta_0+\delta_1x+(\beta_2+\delta_2)x²+(\beta_3+\delta_3)a$$


## Probabilité de survie

On veut trouver le meilleur modèle pour estimer la probabilité de survie $s_a(x)$

```{r}
# On enlève les plantes qui fleurissent (car plante monocarpique)
survdata <- data[data$Flowering0!=1,]
survdata <- survdata[!is.na(survdata$Size1Mars),]

# Probabilité de survie en fonction de la taille de la plante
survdata %>%
  group_by(Size0Mars) %>%
  mutate(survivalProba = sum(SurvieMars, na.rm = TRUE) / n()) %>%
  ggplot(aes(x = Size0Mars, y = survivalProba)) +
  geom_count(aes(y=SurvieMars),alpha=0.6)+
  geom_point() +
  geom_line() +
  ylim(0, 1) +
  theme_bw()

# Probabilité de survie en fonction de l'age de la plante
survdata %>%
  group_by(age0) %>%
  summarize(survivalProba = sum(SurvieMars, na.rm = TRUE) / n()) %>%
  ggplot(aes(x = age0, y = survivalProba)) +
  geom_point() +
  geom_line() +
  ylim(0, 1) +
  theme_bw()

# Probabilité de survie en fonction de l'année
survdata %>%
  group_by(year) %>%
  summarize(survivalProba = sum(SurvieMars, na.rm = TRUE) / n()) %>%
  ggplot(aes(x = year, y = survivalProba)) +
  geom_point() +
  geom_line() +
  ylim(0, 1) +
  theme_bw()

# Probabilité de survie en fonction de la taille de la plante au carrée
survdata %>%
  group_by(s2) %>%
  summarize(survivalProba = sum(SurvieMars, na.rm = TRUE) / n()) %>%
  ggplot(aes(x = s2, y = survivalProba)) +
  geom_point() +
  geom_line() +
  ylim(0, 1) +
  theme_bw()
```

### test selection modele descendant

différence entre l'utilisation de poly et splines
```{r}
library(splines)
Survglm1=fitme(SurvieMars ~ poly(Size0Mars,2) ,family=binomial, data=survdata)
Survglm2=fitme(SurvieMars ~ bs(Size0Mars,df=4,degree=2) + bs(age0,degree=2,knots = 6.5),family=binomial, data=survdata)
# Survglm2=fitme(SurvieMars ~ ns(Size0Mars,df=2)+bs(age0),family=binomial, data=survdata)


# Survglm1=fitme(SurvieMars ~ poly(Size0Mars,1)+poly(age0,1) ,family=binomial, data=survdata)
# Survglm2=fitme(SurvieMars ~ bs(Size0Mars,degree=1)+bs(age0,degree=1),family=binomial, data=survdata)




extractAIC(Survglm1)
extractAIC(Survglm2)

```


```{r}
summary(Survglm1)
summary(Survglm2)
SurvivalPredict1 <- predict(Survglm1)[,1]
SurvivalPredict2 <- predict(Survglm2)[,1]

survdata$SurvivalPredict1 <- SurvivalPredict1
survdata$SurvivalPredict2 <- SurvivalPredict2

ggplot(data = survdata, aes(x = Size0Mars)) +
  geom_count(aes(y = SurvieMars), alpha = 0.6) +
  geom_line(aes(y = SurvivalPredict1)) +
  geom_point(aes(y = SurvivalPredict1),size=0.2) +
  theme_bw() +
  labs(title="utilisation de poly")+
  ylim(0, 1)

ggplot(data = survdata, aes(x = Size0Mars)) +
  geom_count(aes(y = SurvieMars), alpha = 0.6) +
  geom_line(aes(y = SurvivalPredict2)) +
  geom_point(aes(y = SurvivalPredict2),size=0.2) +
  theme_bw() +
  labs(title="utilisation de splines")+
  ylim(0, 1)
```


différence entre l'ordre du polynome




### test selection modele ascendant
```{r}
spaMM.options(separation_max=70)

# Survglm=fitme(SurvieMars ~ poly(Size0Mars,2) + age0+(1+poly(Size0Mars,2) + age0|year) + (1+poly(Size0Mars,2) + age0|Pop),family=binomial, data=survdata, verbose=c(TRACE=TRUE))
# extractAIC(Survglm)

Survglm1=fitme(SurvieMars ~ 1 ,  family=binomial, data=survdata)
Survglm2=fitme(SurvieMars ~ Size0Mars ,  family=binomial, data=survdata)
Survglm3=fitme(SurvieMars ~ age0 ,  family=binomial, data=survdata)
Survglm4=fitme(SurvieMars ~ s2 ,  family=binomial, data=survdata)
Survglm5=fitme(SurvieMars ~ as.factor(age0) ,  family=binomial, data=survdata)


rbind(extractAIC(Survglm1),extractAIC(Survglm2),extractAIC(Survglm3),extractAIC(Survglm4),extractAIC(Survglm5))

```

Taille choisie

```{r}
summary(Survglm2)
Survglm <- Survglm2
SurvivalPredict <- predict(Survglm)[,1]
survdata$SurvivalPredict <- SurvivalPredict
# intercept = -1.735
# beta1 = 0.454


ggplot(data=survdata,aes(x=Size0Mars,y=SurvivalPredict))+
  geom_line()+
  theme_bw()+
  ylim(0,1)
```



```{r}
Survglm1=fitme(SurvieMars ~ Size0Mars ,  family=binomial, data=survdata)
Survglm2=fitme(SurvieMars ~ Size0Mars + s2 ,  family=binomial, data=survdata)
Survglm3=fitme(SurvieMars ~ Size0Mars + age0 ,  family=binomial, data=survdata)
Survglm4=fitme(SurvieMars ~ Size0Mars + as.factor(age0),  family=binomial, data=survdata)
Survglm5=fitme(SurvieMars ~ Size0Mars + a2 ,  family=binomial, data=survdata)


rbind(extractAIC(Survglm1),extractAIC(Survglm2),extractAIC(Survglm3),extractAIC(Survglm4),extractAIC(Survglm5))
```

taille au carrée choisie

```{r}
summary(Survglm2)
Survglm <- Survglm2
SurvivalPredict <- predict(Survglm)[,1]
survdata$SurvivalPredict <- SurvivalPredict
# intercept = -2.094
# beta1 = 0.746
# beta2 = -0.032
survdata %>% group_by(Size0Mars) %>% 
  mutate(SurvivalProba=mean(SurvieMars)) %>% 
ggplot(aes(x=Size0Mars,y=SurvivalPredict))+
  geom_point(aes(y=SurvivalProba),color="red")+
  geom_line()+
  theme_bw()+
  ylim(0,1)

```



```{r}
Survglm1=fitme(SurvieMars ~ Size0Mars + s2 ,  family=binomial, data=survdata)
Survglm2=fitme(SurvieMars ~ Size0Mars + s2 + s3 ,  family=binomial, data=survdata)
Survglm3=fitme(SurvieMars ~ Size0Mars + s2 + age0 ,  family=binomial, data=survdata)
Survglm4=fitme(SurvieMars ~ Size0Mars + s2 + age0+a2 ,  family=binomial, data=survdata)
Survglm5=fitme(SurvieMars ~ Size0Mars + s2 +as.factor(age0) ,  family=binomial, data=survdata)

rbind(extractAIC(Survglm1),extractAIC(Survglm2),extractAIC(Survglm3),extractAIC(Survglm4),extractAIC(Survglm5))
```

```{r}
summary(Survglm3)
Survglm <- Survglm2
SurvivalPredict <- predict(Survglm)[,1]
survdata$SurvivalPredict <- SurvivalPredict
# intercept = -2.094
# beta1 = 0.746
# beta2 = -0.032
survdata %>% group_by(Size0Mars) %>% 
  mutate(SurvivalProba=mean(SurvieMars)) %>% 
ggplot(aes(x=Size0Mars,y=SurvivalPredict))+
  geom_point(aes(y=SurvivalProba),color="red")+
  geom_line()+
  theme_bw()+
  ylim(0,1)

```



```{r}
Survglm1=fitme(SurvieMars ~ Size0Mars + (1|year) + (1|Pop),  family=binomial, data=survdata)
Survglm2=fitme(SurvieMars ~ Size0Mars + s2 + (1|year) + (1|Pop),  family=binomial, data=survdata)
Survglm3=fitme(SurvieMars ~ Size0Mars + age0 + (1|year) + (1|Pop),  family=binomial, data=survdata)
Survglm4=fitme(SurvieMars ~ Size0Mars  + as.factor(age0) + (1|year) + (1|Pop),  family=binomial, data=survdata)


rbind(extractAIC(Survglm1),extractAIC(Survglm2),extractAIC(Survglm3),extractAIC(Survglm4))
anova(Survglm1,Survglm2)
anova(Survglm1,Survglm3)

```

```{r}
Survglm1=fitme(SurvieMars ~ Size0Mars  + as.factor(age0) + (1|year) + (1|Pop),  family=binomial, data=survdata)
Survglm2=fitme(SurvieMars ~ Size0Mars  + as.factor(age0) + s2 +(1|year) + (1|Pop),  family=binomial, data=survdata)
Survglm3=fitme(SurvieMars ~ Size0Mars  + as.factor(age0) + age0 + (1|year) + (1|Pop),  family=binomial, data=survdata)
Survglm4=fitme(SurvieMars ~ Size0Mars  + as.factor(age0) + (Size0Mars|age0) + (1|year) + (1|Pop),  family=binomial, data=survdata)


rbind(extractAIC(Survglm1),extractAIC(Survglm2),extractAIC(Survglm3),extractAIC(Survglm4))
```

```{r}
Survglm1=fitme(SurvieMars ~ Size0Mars  + as.factor(age0) + s2 + (1|year) + (1|Pop),  family=binomial, data=survdata)
Survglm2=fitme(SurvieMars ~ Size0Mars  + as.factor(age0) + s2 + (Size0Mars|age0) + (1|year) + (1|Pop),  family=binomial, data=survdata)
Survglm3=fitme(SurvieMars ~ Size0Mars  + as.factor(age0) + s2 + (Size0Mars|s2) + (1|year) + (1|Pop),  family=binomial, data=survdata)
Survglm4=fitme(SurvieMars ~ Size0Mars  + as.factor(age0) + s2 + (1+Size0Mars|year) + (1|Pop),  family=binomial, data=survdata)
Survglm5=fitme(SurvieMars ~ Size0Mars  + as.factor(age0) + s2 + (Size0Mars|Pop) + (1|year) + (1|Pop),  family=binomial, data=survdata)

rbind(extractAIC(Survglm1),extractAIC(Survglm2),extractAIC(Survglm3),extractAIC(Survglm4),extractAIC(Survglm5))
```

```{r}
Survglm1=fitme(SurvieMars ~ Size0Mars  + as.factor(age0) + s2 + (1|year) + (1|Pop),  family=binomial, data=survdata)
Survglm2=fitme(SurvieMars ~ poly(Size0Mars,3)  + as.factor(age0) + (1|year) + (1|Pop),  family=binomial, data=survdata)
Survglm3=fitme(SurvieMars ~ poly(Size0Mars,3)  + (as.factor(age0)|year) + (1|year) + (1|Pop),  family=binomial, data=survdata)

Survglm4=fitme(SurvieMars ~ poly(Size0Mars,2) + age0+(poly(Size0Mars,2) + age0|year) + (poly(Size0Mars,2) + age0|Pop),  family=binomial, data=survdata)

rbind(extractAIC(Survglm1),extractAIC(Survglm2),extractAIC(Survglm3))

```
1: 10edf 6146 AIC
2: 11edf 6136 AIC
3:  4edf 6145 AIC

best model : size + size² + size³ + as.factor(age0) + (1|year) + (1|Pop)


## Probabilité de floraison


```{r}
#Nombre de plantes en floraison
nFl <- length(data$Flowering0[data$Flowering0 == 1])
nFl

# Plantes en floraison par taille
data %>% group_by(Size0Mars) %>%
  summarize(nF = sum(Flowering0)) %>%
  ggplot(aes(x = Size0Mars, y = nF)) +
    geom_col()

data %>% group_by(age0) %>%
  summarize(nF = sum(Flowering0)) %>%
  ggplot(aes(x = age0, y = nF)) +
    geom_col()

data %>% group_by(year) %>%
  summarize(nF = sum(Flowering0)) %>%
  ggplot(aes(x = year, y = nF)) +
    geom_col()
```


```{r}
Flowglm1 <- fitme(Flowering0 ~ Size0Mars, family=binomial, data=data)
Flowglm2 <- fitme(Flowering0 ~ Size0Mars + age0, family=binomial, data=data)
Flowglm3 <- fitme(Flowering0 ~ Size0Mars + (1|year), family=binomial, data=data)
Flowglm4 <- fitme(Flowering0 ~ Size0Mars + (1|Pop), family=binomial, data=data)
Flowglm5 <- fitme(Flowering0 ~ Size0Mars + as.factor(age0), family=binomial, data=data)
Flowglm6 <- fitme(Flowering0 ~ Size0Mars + s2, family=binomial, data=data)

rbind(extractAIC(Flowglm1),extractAIC(Flowglm2),extractAIC(Flowglm3),extractAIC(Flowglm4),extractAIC(Flowglm5),extractAIC(Flowglm6))
```

```{r}
Flowglm1 <- fitme(Flowering0 ~ Size0Mars + as.factor(age0), family=binomial, data=data)
Flowglm2 <- fitme(Flowering0 ~ poly(Size0Mars,2) + as.factor(age0), family=binomial, data=data)
Flowglm3 <- fitme(Flowering0 ~ poly(Size0Mars,3) + as.factor(age0), family=binomial, data=data)

rbind(extractAIC(Flowglm1),extractAIC(Flowglm2),extractAIC(Flowglm3))

```

```{r}
Flowglm1 <- fitme(Flowering0 ~ poly(Size0Mars,3) + as.factor(age0), family=binomial, data=data)
Flowglm2 <- fitme(Flowering0 ~ poly(Size0Mars,3) + as.factor(age0) + (1|year), family=binomial, data=data)
Flowglm3 <- fitme(Flowering0 ~ poly(Size0Mars,3) + as.factor(age0) + (1|Pop), family=binomial, data=data)
Flowglm4 <- fitme(Flowering0 ~ poly(Size0Mars,3) + as.factor(age0) + (1|Pop) + (1|year), family=binomial, data=data)

rbind(extractAIC(Flowglm1),extractAIC(Flowglm2),extractAIC(Flowglm3),extractAIC(Flowglm4))
```

```{r}
Flowglm1 <- fitme(Flowering0 ~ poly(Size0Mars,3) + as.factor(age0) + (1|Pop) + (1|year), family=binomial, data=data)
Flowglm2 <- fitme(Flowering0 ~ poly(Size0Mars,3) + (1|Pop) + (as.factor(age0)|year), family=binomial, data=data)
Flowglm3 <- fitme(Flowering0 ~ (1|Pop) + (poly(Size0Mars,3)|year), family=binomial, data=data)

rbind(extractAIC(Flowglm1),extractAIC(Flowglm2),extractAIC(Flowglm3))
```

```{r}
Flowglm1 <- fitme(Flowering0 ~ poly(Size0Mars,3) + as.factor(age0) + (1|Pop) + (1|year), family=binomial, data=data)
Flowglm2 <- fitme(Flowering0 ~ poly(Size0Mars,3) + age0 + (1|Pop) + (1|year), family=binomial, data=data) 
Flowglm3 <- fitme(Flowering0 ~ (poly(Size0Mars,3)|Pop) + as.factor(age0) + (1|Pop) + (1|year), family=binomial, data=data)
Flowglm4 <- fitme(Flowering0 ~ poly(Size0Mars,3) + (age0|Pop) + (1|Pop) + (1|year), family=binomial, data=data) 

rbind(extractAIC(Flowglm1),extractAIC(Flowglm2),extractAIC(Flowglm3),extractAIC(Flowglm4))
```

model choisi : 
poly(size,3) + as.factor(age) + (1|year) + (1|Pop)


## Growth rate

```{r}
growthdata <- data[!is.na(data$Size1Mars),]
growthdata <- growthdata[growthdata$Size1Mars!=0,]

growthdata <- growthdata %>% 
  mutate(growthrate=Size1Mars/Size0Mars)

growthdata %>%
  group_by(Size0Mars) %>%
  ggplot(aes(x = Size0Mars, y = growthrate)) +
  geom_point()+
  geom_smooth()

growthdata %>% 
  ggplot(aes(x=factor(age0), y = growthrate)) +
  geom_count()+
  geom_violin(alpha=0.6)

growthdata %>%
  group_by(year) %>%
  ggplot(aes(x = year, y = growthrate)) +
  geom_smooth()
```

```{r}
Growthglm <- fitme(growthrate ~ bs(Size0Mars,df=5)+poly(age0,3)+(1|Pop:year), data=growthdata, resid.model = ~ bs(Size0Mars,df=5)+poly(age0,3))
```

```{r}
Growthglm1 <- fitme(growthrate ~ poly(Size0Mars,3) + as.factor(age0) + (1|Pop) + (1|year), data=growthdata)
Growthglm2 <- fitme(growthrate ~ poly(Size0Mars,3) + as.factor(age0) + (1|Pop) + (poly(Size0Mars,3)|year), data=growthdata)

Growthglm3 <- fitme(growthrate ~ poly(Size0Mars,2) + as.factor(age0) + (1|Pop) + (1|year), data=growthdata)


Growthglm4=fitme(growthrate ~ poly(Size0Mars,3) + age0+ (poly(Size0Mars,3) + age0|year) + (poly(Size0Mars,3) + age0|Pop)+ (poly(Size0Mars,3) + age0|Pop:year), data=growthdata)


rbind(extractAIC(Growthglm1),extractAIC(Growthglm2),extractAIC(Growthglm3),extractAIC(Growthglm4))
```


```{r}
Growthglm1=fitme(growthrate ~ poly(Size0Mars,3) + age0 + (poly(Size0Mars,3) + age0|year) + (poly(Size0Mars,3) + age0|Pop)+ (poly(Size0Mars,3) + age0|Pop:year), data=growthdata)

Growthglm2=fitme(growthrate ~ poly(Size0Mars,3) + age0 + (poly(Size0Mars,3) + age0|year) + (poly(Size0Mars,3) + age0|Pop)+ (poly(Size0Mars,2) + age0|Pop:year), data=growthdata)

Growthglm3=fitme(growthrate ~ poly(Size0Mars,3) + age0 + (poly(Size0Mars,3) + age0|year) + (poly(Size0Mars,3) + age0|Pop)+ (poly(Size0Mars,3)|Pop:year), data=growthdata)

rbind(extractAIC(Growthglm1),extractAIC(Growthglm2),extractAIC(Growthglm3))
```

```{r}
Growthglm1=fitme(growthrate ~ poly(Size0Mars,3) + age0 + (poly(Size0Mars,3) + age0|year) + (poly(Size0Mars,3)|Pop)+ (poly(Size0Mars,3)|Pop:year), data=growthdata)

Growthglm2=fitme(growthrate ~ poly(Size0Mars,3) + age0 + (poly(Size0Mars,3) + age0|year) + (poly(Size0Mars,2) + age0|Pop)+ (poly(Size0Mars,3)|Pop:year), data=growthdata)

Growthglm3=fitme(growthrate ~ poly(Size0Mars,3) + age0 + (poly(Size0Mars,3) + age0|year) + (poly(Size0Mars,3)|Pop:year), data=growthdata)

Growthglm2=fitme(growthrate ~ poly(Size0Mars,3) + age0 + (poly(Size0Mars,3) + age0|year) + (1|Pop)+ (poly(Size0Mars,3)|Pop:year), data=growthdata)

rbind(extractAIC(Growthglm1),extractAIC(Growthglm2),extractAIC(Growthglm3))
```
```{r}
Growthglm1=fitme(growthrate ~ poly(Size0Mars,3) + age0 + (poly(Size0Mars,3) + age0|year) + (poly(Size0Mars,3)|Pop:year), data=growthdata)

Growthglm2=fitme(growthrate ~ poly(Size0Mars,3) + age0 + (poly(Size0Mars,3)|year) + (poly(Size0Mars,3)|Pop:year), data=growthdata)

Growthglm3=fitme(growthrate ~ poly(Size0Mars,3) + age0 + (poly(Size0Mars,3)|Pop:year), data=growthdata)

Growthglm4=fitme(growthrate ~ poly(Size0Mars,3) + age0 + (1:year)+(poly(Size0Mars,3)|Pop:year), data=growthdata)

rbind(extractAIC(Growthglm1),extractAIC(Growthglm2),extractAIC(Growthglm3),extractAIC(Growthglm4))
```

```{r}
Growthglm1=fitme(growthrate ~ poly(Size0Mars,3) + age0 + (poly(Size0Mars,3)|Pop:year), data=growthdata)

Growthglm2=fitme(growthrate ~ poly(Size0Mars,3) + as.factor(age0) + (poly(Size0Mars,3)|Pop:year), data=growthdata)

rbind(extractAIC(Growthglm1),extractAIC(Growthglm2))
```


modèle choisi : poly(size,3) + age + (poly(size,3)|Pop:year)

## Establishment rate

```{r}
Estbdata <- data %>% mutate(PltQ=1,
                            CptlQ=1)
for (i in Estbdata$Quadrat){
  Estbdata$PltQ[Estbdata$Quadrat==i] <- length(Estbdata$Nrw[Estbdata$Quadrat==i & Estbdata$age0==1])
}

Estbdata <- data %>% 
  group_by(Quadrat,year) %>% 
  mutate(Plt=sum(age0))

Estbdata <- Estbdata %>% 
  arrange(Quadrat) 

  mutate(yearPrev=year-1) %>% 
  mutate(CptlQ=sum(data$Cptl0))
Estbdata <- Estbdata %>% mutate(Estb=Estbdata$PltlQ/Estbdata$CptlQ)

```



## Taille de plantules

```{r}
plantuledata <- data[data$age0==1,]

plantuledata %>% group_by(year) %>% mutate(meansize = mean(Size0Mars)) %>%
  ggplot(aes(x = year, y = meansize)) +
  geom_count(aes(x = year, y = Size0Mars), alpha = 0.6) +
  geom_line(color = "red")+
  theme_minimal()+
  ylim(0,10)
  
plantuledata %>% group_by(Pop) %>% mutate(meansize = mean(Size0Mars)) %>%
  ggplot(aes(x = Pop, y = meansize)) +
  geom_count(aes(x = Pop, y = Size0Mars), alpha = 0.6) +
  geom_point(color = "red")+
  theme_minimal()

```

```{r}
Pltglm1=fitme(Size0Mars ~ (1|year), data=plantuledata, family=Gamma(log))
Pltglm2=fitme(Size0Mars ~ (1|year) + (1|Pop), data=plantuledata, family=Gamma(log))
Pltglm3=fitme(Size0Mars ~ (1|year) + (1|Pop) + (1|Nrw), data=plantuledata, family=Gamma(log))


rbind(extractAIC(Pltglm1),extractAIC(Pltglm2),extractAIC(Pltglm3))
```

```{r}
SizePredict <- predict(Pltglm2)[,1]
plantuledata$SizePredict <- SizePredict


ggplot(data=plantuledata,aes(x=year,y=SizePredict))+
  geom_count(alpha=0.6)+
  geom_line(aes(color=as.factor(Pop)))+
  theme_bw()

ggplot(data=plantuledata,aes(x=year,y=SizePredict))+
  geom_point()+
  geom_smooth(aes(color=as.factor(Pop)))+
  theme_bw()
```












