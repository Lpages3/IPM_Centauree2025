---
title: "Integrated Population Model"
author: "Loïc Pages"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
---

# Initialisation
```{r}
rm(list=ls())
library(knitr)
library(spaMM)
library(tidyverse)
library(splines)
library(SplinesUtils)
library(popbio)

setwd("/media/loic/Commun/0Travail/Stage 2025 ISEM/Models/IPM")

centauree_data <- read.csv("donnesIPM_short.csv")
centauree_data_complet <- read.csv("donnesIPM.csv")

MatrixDim <- 50

#Forcer l'age maximal à 8
AgeMax <- 8
centauree_data$age1 <- ifelse(centauree_data$Stage1=="V",centauree_data$age0+1,NA)
centauree_data$age0[centauree_data$age0 > AgeMax] <- AgeMax
centauree_data$age1[centauree_data$age1 > AgeMax] <- AgeMax

spaMM.options(separation_max=70)
```

Age of flowering plants - will be used later to compute optimal growth rate
```{r}
weightAgeFlrPool=NULL
for ( a in 1:AgeMax ) {
  weightAgeFlrPool[a]= nrow(centauree_data[which(centauree_data$age0==a & centauree_data$Flowering0==1),])
}
```

Seedling size distribution
```{r}
plantule_data <- centauree_data_complet[centauree_data_complet$age0==1,] %>% 
  filter(!is.na(age0))

n_plt <- length(plantule_data$Nrw)

sizeSeedl <- unique(plantule_data$Size0Mars[order(plantule_data$Size0Mars)])

Width <-NULL 
Den <- NULL 

for (i in 1:length(sizeSeedl)){
  # Number of observations for each size
  Width[i] <- length(unique(plantule_data$Nrw[plantule_data$Size0Mars==sizeSeedl[i]]))
  # Frequency of each size
  Den[i] <- Width[i]/n_plt
}
Width
Den
dens <- rep(Den,Width)

# densSeedl=function(y,intervalle)
# {   miny=min(y)
#   maxy=max(y)
#   SeedlgSize=exp(log(coef(gg1)[2])-y*coef(gg1)[2])/(exp(-coef(gg1)[2]*(miny-intervalle/2))-exp(-coef(gg1)[2]*(maxy+intervalle/2)))
#   return(SeedlgSize)
# }
```

## Models

Load the false data set which contains the predicted responses for survival probability, flowering probability, number of capitules (fecondity) and growth. There is a value of each of these response for each combination of size, age, population and year.
```{r}
load("Prediction")
```

Creation of the functions for the kernels. 
```{r}
#Fecundity

numbofcap <- function(x,a) {
   sortie <- fake_data$CapituleNbr[fake_data$age0==1 & fake_data$Size0Mars==10][[1]]
   return(matrix(sortie,MatrixDim,MatrixDim,byrow = T ))
   }

#Survival Probability

sx0 <- function(x,a) {
  sortie <- fake_data$SurvivalProbab[fake_data$age0==a & fake_data$Size0Mars==x]
  return(mean(sortie))}


#Flowering Probability 
#Beta = will be used to modify the intercept of the flowering function
#obs_beta = observed value
#extract Beta0
load("obs_beta")
load("se_obs_beta")


#Flowering function for The survival-growth kernel
flr0 <- function(x,a,Beta=0) {
  sortie <- fake_data$FloweringProba[fake_data$age0==a & fake_data$Size0Mars==x] + Beta
  return(mean(sortie))
}

#Flowering function for fecundity fyx0 - same function the difference is in the format of the output
flr1 <- function(x,a,Beta) {
  sortie <- fake_data$FloweringProba[fake_data$age0==a & fake_data$Size0Mars==x] + Beta
  sortie2=mean(sortie)
  return(matrix(sortie2,MatrixDim,MatrixDim,byrow = T ))
}

#Combine fecundity and flowering probability 
fyx0 <- function(y, x ,a, Estbl, Beta, intervalle) {
  #flowering probability:
  p.flow <-flr1(x,a, Beta)
  #number of capitula per flowering plant
  n.captl <-numbofcap(x,a)
  #Seedlings Size distribution
  ProporSeedlSize=densSeedl(y, intervalle)
  
  Fyx0=ifelse((p.flow*n.captl*Estbl*ProporSeedlSize) >=0,p.flow*n.captl*Estbl*ProporSeedlSize,0)
  return(Fyx0)
}

```


Compute kernel version modifiée par Adèle
```{r}
# Compute kernel
K.fnc0 <- function(age, n.size, estbl, Beta) {
  # midpoints for an individual of age a
  minsize = max(0.5,min(centauree_data$Size0Mars[centauree_data$age0==age], na.rm=T)-0.5)
  maxsize = 0.5+max(centauree_data$Size0Mars[centauree_data$age0==age], na.rm=T)
  
  h = (maxsize - minsize) / n.size
  b = minsize + c(0:n.size) * h
  y.a = 0.5 * (b[1:n.size] + b[2:(n.size + 1)])
  
  # midpoints for an individual of age a+1 (a1)
  if (age != AgeMax) {
    minsize = max(0.5,min(centauree_data$Size0Mars[centauree_data$age0==(age+1)], na.rm=T)-0.5)
    maxsize = 0.5+max(centauree_data$Size0Mars[centauree_data$age0==(age+1)], na.rm=T)
    ha1 = (maxsize - minsize) / n.size
    b = minsize + c(0:n.size) * ha1
    y.a1 = 0.5 * (b[1:n.size] + b[2:(n.size + 1)])
  } else {
    minsize = max(0.5,min(centauree_data$Size0Mars[centauree_data$age0==AgeMax], na.rm=T)-0.5)
    maxsize = 0.5+max(centauree_data$Size0Mars[centauree_data$age0==AgeMax], na.rm=T)
    ha1 = (maxsize - minsize) / n.size
    b = minsize + c(0:n.size) * ha1
    y.a1 = 0.5 * (b[1:n.size] + b[2:(n.size + 1)])
  }
  
  # midpoints for an individual of age 1
  minsize = max(0.5,min(Dataglob$Size0Mars[Dataglob$age0==1], na.rm=T) - 0.5)  
  maxsize = 0.5 + max(Dataglob$Size0Mars[Dataglob$age0 == 1], na.rm = T)
  h1 = (maxsize - minsize) / n.size
  b = minsize + c(0:n.size) * h1
  y.1 = 0.5 * (b[1:n.size] + b[2:(n.size + 1)])
  
  
  #The growth kernel
  G <- ha1*outer(y.a1, y.a, Gyx0, a=age)
 
####the following to make G sum to 1.0 in the event that there is some 'eviction' of individuals 
		for(i in 1:(n.size/2)) G[1,i]<-G[1,i]+1-sum(G[,i])
		for(i in (n.size/2+1):n.size) G[n.size,i]<-G[n.size,i]+1-sum(G[,i])	

  
  
  #The survival-growth kernel #remove  flowering plants since they died
  S_flr <- sx0(y.a,age)*(1-flr0(y.a,age, Beta))
  Ps <- sweep(G, MARGIN=2, S_flr, '*')
  P <- matrix(Ps, nrow=n.size)
  
  #Fecundity
  Fec <- h1*outer(y.1, y.a, fyx0 , a=age, Estbl=estbl, Beta=Beta, intervalle=h1)*sx0(y.1,1)
  IPMk=P+Fec
  return(list(M=IPMk,Pk=P,Fk=Fec))
 
}
```

