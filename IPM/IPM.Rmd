---
title: "Integrated Population Model"
author: "Eric Imbert & Loïc Pages"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
---

# Initialisation
```{r}
rm(list=ls())
library(knitr)
library(spaMM)
library(tidyverse)
library(popbio)

setwd("/media/loic/Commun/0Travail/Stage 2025 ISEM/Models/IPM")

centauree_data <- read.csv("donnesIPM_short.csv")
centauree_data_complet <- read.csv("donnesIPM.csv")

MatrixDim <- 50
RecrRate <- 0.407 #recruitment rate

#Forcer l'age maximal à 8
AgeMax <- 8
centauree_data$age1 <- ifelse(centauree_data$Stage1=="V",centauree_data$age0+1,NA)
centauree_data$age0[centauree_data$age0 > AgeMax] <- AgeMax
centauree_data$age1[centauree_data$age1 > AgeMax] <- AgeMax

spaMM.options(separation_max=70)
```

Age of flowering plants - will be used later to compute optimal growth rate
```{r}
weightAgeFlrPool=NULL
for ( a in 1:AgeMax ) {
  weightAgeFlrPool[a]= nrow(centauree_data[which(centauree_data$age0==a & centauree_data$Flowering0==1),])
}
```

Seedling size distribution
```{r}
plantule_data <- centauree_data_complet[centauree_data_complet$age0==1,] %>% 
  filter(!is.na(age0)) %>% 
  filter(Size0Mars!=0)

n_plt <- length(plantule_data$Nrw)

sizeSeedl <- unique(plantule_data$Size0Mars[order(plantule_data$Size0Mars)])

Width <-NULL 
Den <- NULL 

for (i in 1:length(sizeSeedl)){
  # Number of observations for each size
  Width[i] <- length(unique(plantule_data$Nrw[plantule_data$Size0Mars==sizeSeedl[i]]))
  # Frequency of each size
  Den[i] <- Width[i]/n_plt
}
Width
Den
dens <- rep(Den,Width)

gg1=lm(log(1/dens)~rep(sizeSeedl,Width))

densSeedl=function(y,intervalle){   
  miny=min(y)
  maxy=max(y)
  SeedlgSize=exp(log(coef(gg1)[2])-y*coef(gg1)[2])/(exp(-coef(gg1)[2]*(miny-intervalle/2))-exp(-coef(gg1)[2]*(maxy+intervalle/2)))
  return(SeedlgSize)
}
```

## Models

Load the false data set which contains the predicted responses for survival probability, flowering probability, number of capitules (fecondity) and growth. There is a value of each of these response for each combination of size, age, population and year.
```{r}
## Creation of fake data
AgeMax <- 8
year <- 1995:2022
Pop <- c("Po","Au","Pe","E1","E2","Cr")
taille_range <- seq(0.5, 25, by = 0.5) 
age_range <- 1:AgeMax
# 
# fake_data <- expand.grid(
#   year = annees,
#   Pop = populations,
#   Size0Mars = NA,
#   age0 = NA)
# 

Pop=gl(6,length(year),labels = Pop)
rer=data.frame(Pop,year)
rer$Index=1:(length(year)*6)
fake_data=do.call("rbind", replicate(MatrixDim, rer, simplify = FALSE))
fake_data=fake_data[order(fake_data$Index),]
fake_data$Size0Mars=NA
fake_data$age0=NA

rm(rer, Pop, year)


load("Models")
```

Creation of the functions for the kernels. 
```{r}
#Fecundity
numbofcap <- function(x, a) {
  fake_data$age0 <- a
  fake_data$Size0Mars <- unique(x)
  sortie <- predict(Cptlglm1, fake_data)
  sortie2 <- aggregate(sortie, list(fake_data$Size0Mars), mean)
  return(matrix(sortie2$V1, MatrixDim, MatrixDim, byrow = T))
}

#Survival Probability
sx0 <- function(x, a) {
  fake_data$age0 <- a
  fake_data$Size0Mars <- x
  sortie <- predict(Survglm1, fake_data, allow.new.levels = T)
  sortie2 <- aggregate(sortie, list(fake_data$Size0Mars), mean)
  return(sortie2$V1)
}


#Flowering Probability
#Beta = will be used to modify the intercept of the flowering function
#obs_beta = observed value
#extract Beta0
load("obs_beta")
load("se_obs_beta")


#Flowering function for The survival-growth kernel
flr0 <- function(x, a, Beta) {
  fake_data$age0 <- a
  fake_data$Size0Mars <- unique(x)
  sortie <- plogis(predict(Flowglm1, fake_data, allow.new.levels = T, type = "link") + Beta)
  sortie2 <- aggregate(sortie, list(fake_data$Size0Mars), mean)
  return(sortie2$V1)
}

#Flowering function for fecundity fyx0 - same function the difference is in the format of the output
flr1 <- function(x, a, Beta) {
  fake_data$age0 <- a
  fake_data$Size0Mars <- unique(x)
  sortie <- plogis(predict(Flowglm1, fake_data, allow.new.levels = T, type = "link") + Beta)
  sortie2 <- aggregate(sortie, list(fake_data$Size0Mars), mean)
  return(matrix(sortie2$V1, MatrixDim, MatrixDim, byrow = T))
}


#Growth function
Gyx0 <- function (y, x, a) {
  fake_data$age0 <- a
  fake_data$Size0Mars <- unique(x)
  sortie <- exp(predict(Growthglm1, fake_data, allow.new.levels = T))
  sortie2 <- aggregate(sortie, list(fake_data$Size0Mars), mean)
  M <- matrix(sortie2$V1, MatrixDim, MatrixDim, byrow = T)
  SD <- sd(sortie)
  return(dnorm(y, mean = M, sd = SD))
}

#Combine fecundity and flowering probability 
fyx0 <- function(y, x , a, Estbl, Beta = 0, intervalle) {
  #flowering probability:
  p.flow <- flr1(x, a, Beta)
  #number of capitula per flowering plant
  n.captl <- numbofcap(x, a)
  #Seedlings Size distribution
  ProporSeedlSize <- densSeedl(y, intervalle)
  
  Fyx0 <- ifelse((p.flow * n.captl * Estbl * ProporSeedlSize) >= 0,
                 p.flow * n.captl * Estbl * ProporSeedlSize,
                 0)
  return(Fyx0)
}

```


Compute kernel version modifiée par Adèle
```{r}
# Compute kernel
K.fnc0 <- function(age, n.size, estbl, Beta=0) {
  # midpoints for an individual of age a
  minsize = max(0.5,min(centauree_data$Size0Mars[centauree_data$age0==age], na.rm=T)-0.5)
  maxsize = 0.5+max(centauree_data$Size0Mars[centauree_data$age0==age], na.rm=T)
  
  h = (maxsize - minsize) / n.size
  b = minsize + c(0:n.size) * h
  y.a = 0.5 * (b[1:n.size] + b[2:(n.size + 1)])
  
  # midpoints for an individual of age a+1 (a1)
  if (age != AgeMax) {
    minsize = max(0.5,min(centauree_data$Size0Mars[centauree_data$age0==(age+1)], na.rm=T)-0.5)
    maxsize = 0.5+max(centauree_data$Size0Mars[centauree_data$age0==(age+1)], na.rm=T)
    ha1 = (maxsize - minsize) / n.size
    b = minsize + c(0:n.size) * ha1
    y.a1 = 0.5 * (b[1:n.size] + b[2:(n.size + 1)])
  } else {
    minsize = max(0.5,min(centauree_data$Size0Mars[centauree_data$age0==AgeMax], na.rm=T)-0.5)
    maxsize = 0.5+max(centauree_data$Size0Mars[centauree_data$age0==AgeMax], na.rm=T)
    ha1 = (maxsize - minsize) / n.size
    b = minsize + c(0:n.size) * ha1
    y.a1 = 0.5 * (b[1:n.size] + b[2:(n.size + 1)])
  }
  
  # midpoints for an individual of age 1
  minsize = max(0.5,min(centauree_data_complet$Size0Mars[centauree_data_complet$age0==1], na.rm=T) - 0.5)  
  maxsize = 0.5 + max(centauree_data_complet$Size0Mars[centauree_data_complet$age0 == 1], na.rm = T)
  h1 = (maxsize - minsize) / n.size
  b = minsize + c(0:n.size) * h1
  y.1 = 0.5 * (b[1:n.size] + b[2:(n.size + 1)])
  
  
  #The growth kernel
  G <- ha1*outer(y.a1, y.a, Gyx0, a=age)
 
####the following to make G sum to 1.0 in the event that there is some 'eviction' of individuals 
		for(i in 1:(n.size/2)) G[1,i]<-G[1,i]+1-sum(G[,i])
		for(i in (n.size/2+1):n.size) G[n.size,i]<-G[n.size,i]+1-sum(G[,i])	

  
  
  #The survival-growth kernel #remove  flowering plants since they died
  S_flr <- sx0(y.a,age)*(1-flr0(y.a,age, Beta))
  Ps <- sweep(G, MARGIN=2, S_flr, '*')
  P <- matrix(Ps, nrow=n.size)
  
  #Fecundity
  Fec <- h1*outer(y.1, y.a, fyx0 , a=age, Estbl=estbl, Beta=Beta, intervalle=h1)*sx0(y.1,1)
  IPMk=P+Fec
  return(list(M=IPMk,Pk=P,Fk=Fec))
 
}
```


the super matrix and growth rate
```{r}

super_matrix=function(Beta_test)
{

Pk=matrix(data=NA, nrow=MatrixDim, ncol=MatrixDim)
Fk=matrix(data=NA, nrow=MatrixDim, ncol=MatrixDim)
Mk=matrix(data=NA, nrow=MatrixDim, ncol=MatrixDim)
Kernals=array(data=0, dim=c(AgeMax,3,MatrixDim,MatrixDim))
GlobMatrIPM=array(0,dim=c((AgeMax*MatrixDim),(AgeMax*MatrixDim)))

for (a in (1:(AgeMax-1)))
{
  Kls=K.fnc0(a,MatrixDim,RecrRate, Beta_test)  
  Kernals[a,1,,]=Kls$M
  Kernals[a,2,,]=Kls$Pk
  Kernals[a,3,,]=Kls$Fk
  #print(lambda(Kernals[a,1,,])) 
  debut=(a-1)*MatrixDim+1
  fin=debut+(MatrixDim-1)
  GlobMatrIPM[1:MatrixDim,(debut:fin)]=Kls$Fk
  GlobMatrIPM[((fin+1):(fin+MatrixDim)),(debut:fin)]=Kls$Pk
 
}

Kls=K.fnc0(AgeMax,MatrixDim,RecrRate, Beta_test)  
  Kernals[AgeMax,1,,]=Kls$M
  Kernals[AgeMax,2,,]=Kls$Pk
  Kernals[AgeMax,3,,]=Kls$Fk
  #print(lambda(Kernals[a,1,,])) 
  debut=(AgeMax-1)*MatrixDim+1
  fin=debut+(MatrixDim-1)
  GlobMatrIPM[1:MatrixDim,(debut:fin)]=Kls$Fk
  GlobMatrIPM[(debut:fin),(debut:fin)]=Kls$Pk

  return(lambda(GlobMatrIPM))
  }

```


```{r}
obs_lambda=super_matrix(0) # growthrate values reported in table 1
print(obs_lambda)
print(obs_beta)

mean_size=mean(centauree_data_complet$Size0Mars[which(centauree_data_complet$Flowering0==1)])
sd_size=sd(centauree_data_complet$Size0Mars[which(centauree_data_complet$Flowering0==1)])
print(mean_size)
print(sd_size)

mean_age=mean(centauree_data_complet$age0[which(centauree_data_complet$Flowering0==1)], na.rm=T)
sd_age=sd(centauree_data_complet$age0[which(centauree_data_complet$Flowering0==1)], na.rm=T)

print(mean_age)
print(sd_age)

```
