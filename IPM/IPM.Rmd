---
title: "Integrated Population Model"
author: "Loïc Pages"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
---

# Initialisation
```{r}
rm(list=ls())
library(knitr)
library(spaMM)
library(tidyverse)
library(splines)
library(SplinesUtils)
library(popbio)

setwd("/media/loic/Commun/0Travail/Stage 2025 ISEM/Models")

centauree_data <- read.csv("donnesIPM_short.csv")
centauree_data_complet <- read.csv("donnesIPM.csv")

MatrixDim <- 50

#Forcer l'age maximal à 8
AgeMax <- 8
centauree_data$age1 <- ifelse(centauree_data$Stage1=="V",centauree_data$age0+1,NA)
centauree_data$age0[centauree_data$age0 > AgeMax] <- AgeMax
centauree_data$age1[centauree_data$age1 > AgeMax] <- AgeMax

spaMM.options(separation_max=70)
```

Age of flowering plants - will be used later to compute optimal growth rate
```{r}
weightAgeFlrPool=NULL
for ( a in 1:AgeMax ) {
  weightAgeFlrPool[a]= nrow(centauree_data[which(centauree_data$age0==a & centauree_data$Flowering0==1),])
}
```

Seedling size distribution
```{r}
plantule_data <- centauree_data_complet[centauree_data_complet$age0==1,] %>% 
  filter(!is.na(age0))

n_plt <- length(plantule_data$Nrw)

sizeSeedl <- unique(plantule_data$Size0Mars[order(plantule_data$Size0Mars)])

Width <-NULL 
Den <- NULL 

for (i in 1:length(sizeSeedl)){
  # Number of observations for each size
  Width[i] <- length(unique(plantule_data$Nrw[plantule_data$Size0Mars==sizeSeedl[i]]))
  # Frequency of each size
  Den[i] <- Width[i]/n_plt
}
Width
Den
dens <- rep(Den,Width)

# densSeedl=function(y,intervalle)
# {   miny=min(y)
#   maxy=max(y)
#   SeedlgSize=exp(log(coef(gg1)[2])-y*coef(gg1)[2])/(exp(-coef(gg1)[2]*(miny-intervalle/2))-exp(-coef(gg1)[2]*(maxy+intervalle/2)))
#   return(SeedlgSize)
# }
```

## Models

Load the false data set which contains the predicted responses for survival probability, flowering probability, number of capitules (fecondity) and growth. There is a value of each of these response for each combination of size, age, population and year.
```{r}
load("Prediction")
```

Creation of the functions for the kernels. 
```{r}
#Fecundity

numbofcap <- function(x,a) {
   sortie <- fake_data$CapituleNbr[fake_data$age0==1 & fake_data$Size0Mars==10][[1]]
   return(matrix(sortie,MatrixDim,MatrixDim,byrow = T ))
   }

#Survival Probability

sx0 <- function(x,a) {
  mean(fake_data[fake_data$age0==a,fake_data$Size0Mars==x])
  
  
  fake_data$age0=a
  fake_data$Size0Mars=x
  fake_data$s2=fake_data$Size0Mars^2
  sortie=predict(SurvGlm, fake ,re.form=~ (age0|year) + (1|year) + (1|Pop),  allow.new.levels=T)
  sortie2=aggregate(sortie,list(fake_data$Size0Mars),mean)
  return(sortie2$V1)}
```

