y = "Survival probability")
fake_data1 %>%
mutate(surv = Survpredict11,
var = resSurv1)%>%
group_by(Size0Mars,year) %>%
mutate(surv_predi = mean(surv, na.rm = TRUE),
var = mean(var),
.group="drop") %>%
ggplot(aes(x = Size0Mars, y = surv_predi)) +
geom_ribbon(aes(ymin=surv_predi-var,ymax=surv_predi+var,fill=as.factor(year)),alpha=0.01)+
geom_line(aes(color=as.factor(year))) +
theme_bw()+
ylim(0, 1) +
xlim(0,9)+
labs(title = "Survie prédites des plantules",
subtitle = "Moyenne de la survie sur les années et les populations",
x = "Size",
y = "Survival probability")
fake_data1 %>%
mutate(surv = Survpredict11,
var = resSurv1)%>%
group_by(Size0Mars,year) %>%
mutate(surv_predi = mean(surv, na.rm = TRUE),
var = mean(var),
.group="drop") %>%
ggplot(aes(x = Size0Mars, y = surv_predi)) +
geom_ribbon(aes(ymin=surv_predi-var,ymax=surv_predi+var,fill=as.factor(year)),alpha=0.1)+
geom_line(aes(color=as.factor(year))) +
theme_bw()+
ylim(0, 1) +
xlim(0,9)+
labs(title = "Survie prédites des plantules",
subtitle = "Moyenne de la survie sur les années et les populations",
x = "Size",
y = "Survival probability")
fake_data1 %>%
mutate(surv = Survpredict11,
var = resSurv1)%>%
group_by(Size0Mars,year) %>%
mutate(surv_predi = mean(surv, na.rm = TRUE),
var = mean(var),
.group="drop") %>%
ggplot(aes(x = Size0Mars, y = surv_predi)) +
geom_ribbon(aes(ymin=surv_predi-var,ymax=surv_predi+var,fill=as.factor(year)),alpha=0.01)+
geom_line(aes(color=as.factor(year))) +
theme_bw()+
ylim(0, 1) +
xlim(0,9)+
labs(title = "Survie prédites des plantules",
subtitle = "Moyenne de la survie sur les années et les populations",
x = "Size",
y = "Survival probability")
fake_data1 %>%
mutate(surv = Survpredict11,
var = resSurv1)%>%
group_by(Size0Mars,year) %>%
mutate(surv_predi = mean(surv, na.rm = TRUE),
var = mean(var),
.group="drop") %>%
ggplot(aes(x = Size0Mars, y = surv_predi)) +
geom_ribbon(aes(ymin=surv_predi-var,ymax=surv_predi+var),alpha=0.01)+
geom_line(aes(color=as.factor(year))) +
theme_bw()+
ylim(0, 1) +
xlim(0,9)+
labs(title = "Survie prédites des plantules",
subtitle = "Moyenne de la survie sur les années et les populations",
x = "Size",
y = "Survival probability")
fake_data1 %>%
mutate(surv = Survpredict11,
var = resSurv1)%>%
group_by(Size0Mars,year) %>%
mutate(surv_predi = mean(surv, na.rm = TRUE),
var = mean(var),
.group="drop") %>%
ggplot(aes(x = Size0Mars, y = surv_predi)) +
geom_ribbon(aes(ymin=surv_predi-var,ymax=surv_predi+var),alpha=0.1)+
geom_line(aes(color=as.factor(year))) +
theme_bw()+
ylim(0, 1) +
xlim(0,9)+
labs(title = "Survie prédites des plantules",
subtitle = "Moyenne de la survie sur les années et les populations",
x = "Size",
y = "Survival probability")
fake_data1 %>%
mutate(surv = Survpredict11,
var = resSurv1)%>%
group_by(Size0Mars,year) %>%
mutate(surv_predi = mean(surv, na.rm = TRUE),
var = mean(var),
.group="drop") %>%
ggplot(aes(x = Size0Mars, y = surv_predi)) +
geom_ribbon(aes(ymin=surv_predi-var,ymax=surv_predi+var))+
geom_line(aes(color=as.factor(year))) +
theme_bw()+
ylim(0, 1) +
xlim(0,9)+
labs(title = "Survie prédites des plantules",
subtitle = "Moyenne de la survie sur les années et les populations",
x = "Size",
y = "Survival probability")
resSurv1 <- get_residVar(Survglm11,newdata = fake_data1)
fake_data1 %>%
mutate(surv = Survpredict11,
var = resSurv1)%>%
group_by(Size0Mars,year) %>%
mutate(surv_predi = mean(surv, na.rm = TRUE),
var = mean(var),
.group="drop") %>%
ggplot(aes(x = Size0Mars, y = surv_predi)) +
geom_ribbon(aes(ymin=surv_predi-var,ymax=surv_predi+var))+
geom_line(aes(color=as.factor(year))) +
theme_bw()+
ylim(0, 1) +
xlim(0,9)+
labs(title = "Survie prédites des plantules",
subtitle = "Moyenne de la survie sur les années et les populations",
x = "Size",
y = "Survival probability")
fake_data1 %>%
mutate(surv = Survpredict11,
var = resSurv1)%>%
group_by(Size0Mars,year) %>%
mutate(surv_predi = mean(surv, na.rm = TRUE),
var = mean(var,na.rm = TRUE),
.group="drop") %>%
ggplot(aes(x = Size0Mars, y = surv_predi)) +
geom_ribbon(aes(ymin=surv_predi-var,ymax=surv_predi+var))+
geom_line(aes(color=as.factor(year))) +
theme_bw()+
ylim(0, 1) +
xlim(0,9)+
labs(title = "Survie prédites des plantules",
subtitle = "Moyenne de la survie sur les années et les populations",
x = "Size",
y = "Survival probability")
resSurv1 <- get_residVar(Survglm11,newdata = fake_data1)
fake_data1 %>%
mutate(surv = Survpredict11,
var = resSurv1)%>%
group_by(Size0Mars,year) %>%
mutate(surv_predi = mean(surv, na.rm = TRUE),
var = mean(var)) %>%
ggplot(aes(x = Size0Mars, y = surv_predi)) +
geom_ribbon(aes(ymin=surv_predi-var,ymax=surv_predi+var))+
geom_line(aes(color=as.factor(year))) +
theme_bw()+
ylim(0, 1) +
xlim(0,9)+
labs(title = "Survie prédites des plantules",
subtitle = "Moyenne de la survie sur les années et les populations",
x = "Size",
y = "Survival probability")
#Survie plantules
resSurv1 <- residVar(Survglm11,newdata = fake_data1)
fake_data1 %>%
mutate(surv = Survpredict11,
resSurv = resSurv1) %>%
group_by(Size0Mars) %>%
summarise(surv_predi = mean(surv, na.rm = TRUE),
resSurv = mean(resSurv, na.rm = TRUE)) %>%
ggplot(aes(x = Size0Mars, y = surv_predi)) +
geom_ribbon(aes(ymin=surv_predi-resSurv, ymax=surv_predi+resSurv),fill = "red", alpha=0.08)+
geom_line(color="red") +
theme_minimal() +
ylim(0, 1) +
xlim(0,9)+
labs(title = "Survie prédites des plantules",
subtitle = "Moyenne de la survie sur les années et les populations",
x = "Taille",
y = "Probabilité de survie")
load("/home/loic/Downloads/COMPADRE_v.6.23.5.0.RData")
View(compadre)
compadre[["version"]][["Database"]]
compadre[["mat"]][[1]]
compadre[["matrixClass"]][[6]]
compadre[["metadata"]][["MatrixDimension"]]
compadre[["metadata"]][["ProjectionInterval"]]
max(compadre[["metadata"]][["ProjectionInterval"]])
max(compadre[["metadata"]][["ProjectionInterval"]],na.rm=TRUE)
min(compadre[["metadata"]][["ProjectionInterval"]],na.rm=TRUE)
mean(compadre[["metadata"]][["ProjectionInterval"]],na.rm=TRUE)
mean(as.numeric(compadre[["metadata"]][["ProjectionInterval"]]),na.rm=TRUE)
median(as.numeric(compadre[["metadata"]][["ProjectionInterval"]]),na.rm=TRUE)
compadre[["metadata"]][["Species"]]
rm(list=ls())
library(knitr)
library(spaMM)
library(tidyverse)
library(splines)
library(foreach)
library(doParallel)
setwd("/media/loic/Commun/0Travail/Stage 2025 ISEM/Models")
centauree_data <- read.csv("donnesIPM_short.csv")
centauree_data_complet <- read.csv("donnesIPM.csv")
#Supprimer plantes dont l'age est inconnu
centauree_data <- centauree_data[!is.na(centauree_data$age0), ]
#Ajouter valeur de l'age à t+1
centauree_data$age1 <- ifelse(centauree_data$Stage1=="V",centauree_data$age0+1,NA)
#Forcer l'age maximal à 8
centauree_data$age0[centauree_data$age0 > 8] <- 8
centauree_data$age1[centauree_data$age1 > 8] <- 8
spaMM.options(separation_max=70)
annees <- 1995:2022
populations <- c("Po","Au","Pe","E1","E2","Cr")
taille_range <- seq(0.5, 25, by = 0.5)
age_range <- 1:8
fake_data <- expand.grid(
year = annees,
Pop = populations,
Size0Mars = taille_range,
age0 = age_range
)
fake_data <- fake_data %>%
mutate(Nrw = row_number())
fake_data1 <- fake_data[fake_data$age0==1,]
fake_data2 <- fake_data[fake_data$age0>1,]
fake_data3 <- expand.grid(
year = annees,
Pop = populations,
Size0Mars = taille_range,
age0 = age_range,
Size1 = taille_range)
# extractBIC <- function(fit, n){
#   extractAIC(fit)[[2]]+(log(n)-2)*DoF(fit)[[3]]
# }
# N the number of subjects
# ntot the total number of observations
extractBIC <- function(fit, ntot, N){
extractAIC(fit)[[2]] +(log(ntot)-2)*DoF(fit)[[3]] + log(N)*DoF(fit)[[1]]
}
survdata <- centauree_data[centauree_data$Flowering0!=1,]
# survdata$SurvieMars[survdata$age0==7][1:15] <- 0
survdata %>%
group_by(Size0Mars) %>%
mutate(survivalProba = sum(SurvieMars, na.rm = TRUE) / n()) %>%
ggplot(aes(x = Size0Mars, y = SurvieMars)) +
geom_count(alpha = 0.6) +  # Points dimensionnés selon la fréquence
geom_point(aes(y = survivalProba), color = "red", size = 0.5) +
geom_line(aes(y = survivalProba), color = "red") +
labs(title = "Relation entre la survie et la taille",
x = "Taille",
y = "Survie",
subtitles = "Points gris: survie réelle des individus (0 ou 1)
Points rouge: survie moyenne par classe de taille") +
ylim(0, 1) +
theme_minimal()
survdata %>%
group_by(age0) %>%
mutate(survivalProba = sum(SurvieMars, na.rm = TRUE) / n()) %>%
ggplot(aes(x = age0, y = SurvieMars)) +
geom_count(alpha = 0.6) +  # Points dimensionnés selon la fréquence
geom_point(aes(x = age0, y = survivalProba), color = "red", size = 1) +
geom_line(aes(x = age0, y = survivalProba), color = "red") +
labs(title = "Relation entre la survie et l'age",
x = "age",
y = "Survie",
subtitles = "Points gris: survie réelle des individus (0 ou 1)
Points rouge: survie moyenne par classe d'age") +
ylim(0, 1) +
theme_minimal()
survdata1 <- survdata[survdata$age0==1,]
survdata1 %>%
group_by(Size0Mars) %>%
mutate(survivalProba = sum(SurvieMars, na.rm = TRUE) / n()) %>%
ggplot(aes(x = Size0Mars, y = SurvieMars)) +
geom_count(alpha = 0.6) +  # Points dimensionnés selon la fréquence
geom_point(aes(y = survivalProba), color = "red", size = 0.5) +
geom_line(aes(y = survivalProba), color = "red") +
labs(title = "Relation entre la survie des plantules et la taille",
x = "Taille",
y = "Survie",
subtitles = "Points gris: survie réelle des individus (0 ou 1)
Points rouge: survie moyenne par classe d'age") +
ylim(0, 1) +
theme_minimal()
survdata2 <- survdata[survdata$age0>1,]
survdata2 %>%
group_by(Size0Mars) %>%
mutate(survivalProba = sum(SurvieMars, na.rm = TRUE) / n()) %>%
ggplot(aes(x = Size0Mars, y = SurvieMars)) +
geom_count(alpha = 0.6) +  # Points dimensionnés selon la fréquence
geom_point(aes(y = survivalProba), color = "red", size = 0.5) +
geom_line(aes(y = survivalProba), color = "red") +
labs(title = "Relation entre la survie des rosettes et la taille",
x = "Taille",
y = "Survie",
subtitles = "Points gris: survie réelle des individus (0 ou 1)
Points rouge: survie moyenne par classe de taille") +
ylim(0, 1) +
theme_minimal()
survdata2 %>%
group_by(age0) %>%
mutate(survivalProba = sum(SurvieMars, na.rm = TRUE) / n()) %>%
ggplot(aes(x = age0, y = SurvieMars)) +
geom_count(alpha = 0.6) +  # Points dimensionnés selon la fréquence
geom_point(aes(y = survivalProba), color = "red", size = 0.5) +
geom_line(aes(y = survivalProba), color = "red") +
labs(title = "Relation entre la survie des rosettes et l'age",
x = "Age",
y = "Survie",
subtitles = "Points gris: survie réelle des individus (0 ou 1)
Points rouge: survie moyenne par classe d'age") +
ylim(0, 1) +
theme_minimal()
centauree_data %>%
group_by(Size0Mars) %>%
mutate(floweringProba = sum(Flowering0, na.rm = TRUE) / n()) %>%
ggplot(aes(x = Size0Mars, y = Flowering0)) +
geom_count(alpha = 0.6) +
geom_point(aes(y = floweringProba), color = "red", size = 0.5) +
labs(title = "Relation entre la floraison et la taille ",
x = "Taille",
y = "Floraison",
subtitles = "Points gris: floraison réelle des individus (0 ou 1)
Points rouge: floraison moyenne par classe de taille") +
ylim(0, 1) +
theme_minimal()
centauree_data %>%
group_by(age0) %>%
mutate(floweringProba = sum(Flowering0, na.rm = TRUE) / n()) %>%
ggplot(aes(x = age0, y = Flowering0)) +
geom_count(alpha = 0.6) +
geom_point(aes(y = floweringProba), color = "red", size = 0.5) +
geom_line(aes(y = floweringProba), color = "red") +
labs(title = "Relation entre la floraison et l'age",
x = "age",
y = "Floraison",
subtitles = "Points gris: floraison réelle des individus (0 ou 1)
Points rouge: floraison moyenne par classe d'age") +
ylim(0, 1) +
theme_minimal()
plantule_data <- centauree_data[centauree_data$age0==1,]
# Taille des plantules / année
plantule_data %>%
ggplot(aes(x = year, y = Size0Mars)) +
geom_count(alpha=0.6) +
labs(title = "Distribution des tailles de plantules selon les années",
x = "Année",
y = "Taille des plantules") +
theme_minimal()
# Taille des plantules / population
plantule_data %>%
ggplot(aes(x = Pop, y = Size0Mars)) +
geom_count(alpha=0.6) +
labs(title = "Distribution des tailles de plantules selon les populations",
x = "Population",
y = "Taille des plantules") +
theme_minimal()
plantule_data %>%
ggplot(aes(x=Size0Mars))+
geom_histogram()+
xlim(0,8)
growthdata <- centauree_data[!is.na(centauree_data$Size1Mars), ]
growthdata <- growthdata[growthdata$Size1Mars != 0, ]
growthdata %>%
ggplot(aes(y = Size1Mars, x = Size0Mars)) +
geom_count(alpha=0.5) +
labs(title = "Relation entre la taille à l'année suivante et la taille à l'année actuelle",
y = "Taille à t+1",
x = "Taille à t") +
theme_minimal()
growthdata %>%
ggplot(aes(y = log(Size1Mars), x = Size0Mars)) +
geom_count(alpha=0.5) +
labs(title = "Relation log-log entre la taille à l'année suivante et la taille à l'année actuelle",
y = "log Taille à t+1",
x = "Taille à t") +
theme_minimal()
growthdata %>%
ggplot(aes(y = sqrt(Size1Mars), x = Size0Mars)) +
geom_count(alpha=0.5) +
labs(title = "Relation entre la taille à l'année suivante et la taille à l'année actuelle",
y = "racine Taille à t+1",
x = "Taille à t") +
theme_minimal()
cptldata <- centauree_data[!is.na(centauree_data$Cptl0),]
cptldata <- cptldata[!cptldata$Flowering0==0,]
# Nombre de capitule / taille
cptldata %>%
ggplot(aes(x=Size0Mars,y=Cptl0))+
geom_point() +
labs(title = "Relation entre le nombre de capitules et la taille",
x = "Taille",
y = "Nombre de capitules") +
theme_minimal()
# Nombre de capitule / année
cptldata %>%
ggplot(aes(x=year,y=Cptl0))+
geom_point() +
labs(title = "Relation entre le nombre de capitules et l'année",
x = "Année",
y = "Nombre de capitules") +
theme_minimal()
Survglm11 <- fitme(SurvieMars ~ 1 + poly(Size0Mars,3) +
(Size0Mars|year) + (1|Pop),
family=binomial,
data=survdata1,
method="PQL/L")
extractAIC(Survglm11)
Survglm12 <- fitme(SurvieMars ~ 1 + bs(Size0Mars,df=4,degree=2) +(bs(age0,degree=3,knots=6.5)) +
(age0|year) + (1|Pop),
family=binomial,
data=survdata2,
method="PQL/L")
extractAIC(Survglm12)
Flowglm1 <- fitme(Flowering0 ~  1 + poly(Size0Mars,3) + poly(age0,2) +
(age0|Pop),
family=binomial,
data=centauree_data, method="PQL/L")
extractAIC(Flowglm1)
Pltglm1 <- fitme(Size0Mars ~ 1 + (1|year) + (1|Pop) + (1|Pop:year),
data=plantule_data,
family = Gamma(log))
extractAIC(Pltglm1)
Growthglm1 <- fitme(log(Size1Mars) ~ 1 +
poly(log(Size0Mars),4) + poly(age0,3) +
(log(Size0Mars)|year) + (log(Size0Mars)|Pop),
data=growthdata,resid.model = ~log(Size0Mars))
extractAIC(Growthglm1)
Growthglm2 <- fitme(Size1Mars ~ 1 +
bs(Size0Mars,degree=3,df=5) + bs(age0,degree=2,knots=6.5) +
(Size0Mars+age0|year) + (Size0Mars|Pop),
resid.model = ~ log(Size0Mars),
data=growthdata)
cb <- MASS::boxcox(Size1Mars ~ 1, data=growthdata)
cb$x[cb$y==max(cb$y)]
Cptlglm1 <- fitme(Cptl0 ~ 1 + Size0Mars,
data=cptldata)
extractAIC(Cptlglm1)
summary(Survglm11)
summary(Survglm12)
summary(Flowglm1)
summary(Pltglm1)
summary(Cptlglm1)
summary(Growthglm1)
library(SplinesUtils)
#Pour un exemple :
# RegModel <- fitme(SurvieMars ~ 1 + bs(Size0Mars, df = 4, degree = 2) +(bs(age0, degree = 3, knots = 6.5)) + (age0|year) + (1|Pop),
#                   family=binomial,
#                   data=survdata2,
#                   method="PQL/L")
# SplineTerm <- "bs(Size0Mars, df = 4, degree = 2)"
# La fonction d'origine est RegSplineAsPiecePoly
SplinesAsPolySpaMM <- function (RegModel, SplineTerm, shift = TRUE) {
#Extrait les données du spline (position dans les effets fixes, degrés des polynomes, knots)
RegSpline <- SplinesUtils:::ExtractSplineTerm(terms(RegModel), SplineTerm)
pos <- RegSpline$pos
#Permet de sortir les coefficients de chaque bout de splines
ind0 <- attr(RegModel$X.pv, "namesOri") #Noms des coefficients
ind <- integer(0)
pattern <- paste0("^", gsub("\\(", "\\\\(", gsub("\\)", "\\\\)", SplineTerm)), "\\d+$")
#C'est pas très propre mais pas le choix car les noms des bouts de splines finissent avec un indice 1,2,...
ind <- grep(pattern, ind0) #Détecte si le nom du coefficient correspond au spline voulu
RegSplineCoef <- RegModel$fixef[ind] #Sort l'estimation des coeffs
RegSplineCoef <- unname(RegSplineCoef)
na <- is.na(RegSplineCoef)
if (any(na)) {
warning("NA coefficients found for SplineTerm; Replacing NA by 0")
RegSplineCoef[na] <- 0
}
#Recalcule le polynome avec la méthode d'origine, je n'y ai pas touché
PiecePolyCoef <- SplinesUtils:::PiecePolyRepara(RegSpline, RegSplineCoef, shift)
structure(list(
PiecePoly = list(coef = PiecePolyCoef, shift = shift),
knots = RegSpline$knots),
class = c("PiecePoly", "RegSpline"))
}
Survglm11
Survglm11$ranef_info
Survglm11$residModel
Survglm11$muetablob
Survglm11$main_terms_info
Survglm11$main_terms_info$Y
Survglm11$main_terms_info$fixef_off_terms
Survglm11$main_terms_info$fixef_levels
Survglm11$CorrEst_and_RanFix
Survglm11$CorrEst_and_RanFix$corrPars
Survglm11$CorrEst_and_RanFix$ranCoefs
Survglm11
Survglm11$CorrEst_and_RanFix$ranCoefs
-0.77858178*1.57356961*0.06589224
Survglm12
0.9057*1.395*0.009721
Flowglm1
0.9806*0.09044*2.175
Growthglm1
extractAIC(Growthglm1)
Growthglm1 <- fitme(log(Size1Mars) ~ 1 +
poly(Size0Mars,4) + poly(age0,3) +
(Size0Mars|year) + (Size0Mars|Pop),
data=growthdata,resid.model = ~log(Size0Mars))
extractAIC(Growthglm1)
Growthglm1 <- fitme(log(Size1Mars) ~ 1 +
poly(Size0Mars,4) + poly(age0,3) +
(Size0Mars|year) + (Size0Mars|Pop),
data=growthdata,resid.model = ~log(Size0Mars))
extractAIC(Growthglm1)
Growthglm1
Growthglm2
0.005(25-6)**2
0.005*(25-6)**2
SplinesAsPolySpaMM(Growthglm2,"bs(Size0Mars, degree = 3, df = 5)")
Survglm11
Survglm12
Growthglm2
0.000897*23**2
0.000897*3**2
SplinesAsPolySpaMM(Growthglm2,"bs(age0, degree = 2, knots = 6.5)")
Growthglm1
