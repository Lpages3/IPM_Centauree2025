---
title: "Model Selection Report"
author: "Loïc Pages"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  word_document: default
---

# Introduction

## IPM
$$N(y,t+1)=\int N(x,t)(F_a(x,y,t)+P_a(x,y,t))dx$$
avec $x$ la taille à $t$, $y$ la taille à $t+1$, $a$ l'age et $N$ la taille de la population

La probabilité qu'un individu d'age $a$ et de taille $x$ au temps $t$ devienne un individu d'age $a+1$ et de taille $y$ à $t+1$ est :
$$P_a(x,y,t)=s_a(x)(1-f_a(x))G_a(x,y)$$
et la densité d'individus de taille $y$ à $t$ et d'age $1$ (plantules) issus d'un individu de taille $x$ et d'age $a$ à $t$ est :
$$F_a(x,y,t)=f_a(x)C_a(x)w(y)Estb$$


## Sélection de modèles

Méthode utilisée: 
Créer l'ensemble des combinaisons possibles d'effets fixes et aléatoires.
Puis utiliser le package spaMM pour fit les modèles. On calcule ensuite leur AIC (ou leur BIC) qu'on compare entre eux.
On obtient un classement des (5) meilleurs modèles pour chaque trait d'histoire de vie, pour l'AIC et pour le BIC.

Paramètres à modéliser :

Survival Probability

Flowering Probability

Growth

Fecundity (Number of capitula)

Seedling Size Distribution

## Initialisation
```{r,message=FALSE}
rm(list=ls())
library(knitr)
library(spaMM)
library(tidyverse)
library(splines)
library(foreach)
library(doParallel)

setwd("/media/loic/Commun/0Travail/Stage 2025 ISEM/Models")

centauree_data <- read.csv("donnesIPM_short.csv")
centauree_data_complet <- read.csv("donnesIPM.csv")

#Supprimer plantes dont l'age est inconnu
centauree_data <- centauree_data[!is.na(centauree_data$age0), ]

#Ajouter valeur de l'age à t+1
centauree_data$age1 <- ifelse(centauree_data$Stage1=="V",centauree_data$age0+1,NA)

#Forcer l'age maximal à 8
centauree_data$age0[centauree_data$age0 > 8] <- 8
centauree_data$age1[centauree_data$age1 > 8] <- 8

spaMM.options(separation_max=70)
```

```{r,include=FALSE}
annees <- 1995:2022
populations <- c("Po","Au","Pe","E1","E2","Cr")
taille_range <- seq(0.5, 25, by = 0.5) 
age_range <- 1:8

fake_data <- expand.grid(
  year = annees,
  Pop = populations,
  Size0Mars = taille_range,
  age0 = age_range
)

fake_data <- fake_data %>% 
  mutate(Nrw = row_number())

fake_data1 <- fake_data[fake_data$age0==1,]
fake_data2 <- fake_data[fake_data$age0>1,]
fake_data3 <- expand.grid(
  year = annees,
  Pop = populations,
  Size0Mars = taille_range,
  age0 = age_range,
  Size1 = taille_range)
```

```{r,include=FALSE}
extractBIC <- function(fit, n){
  extractAIC(fit)[[2]]+(log(n)-2)*DoF(fit)[[3]]
}

# N the number of subjects
# ntot the total number of observations
extractBIC2 <- function(fit, ntot, N){
  extractAIC(fit)[[2]] +(log(ntot)-2)*DoF(fit)[[3]] + log(N)*DoF(fit)[[1]]
}
```

# Mise en place


## Survival Probability

Pour le probabilité de survie, on a divisé le jeu de données en deux:

1- les plantules (individus d'age 1)

2- les rosettes (individus d'age 2 ou plus)

(La somme des AIC des meilleurs modèles de survie des plantules et des rosettes est inférieure à l'AIC des modèles de survie comprenant tous les ages)

On utilise un modèle binomial pour fit les données de survie (0 ou 1).

Affichage des données brutes de la survie pour tous les ages.

```{r,echo=FALSE,warning=FALSE,out.width="50%"}
survdata <- centauree_data[centauree_data$Flowering0!=1,]
# survdata$SurvieMars[survdata$age0==7][1:15] <- 0

survdata %>%
  group_by(Size0Mars) %>%
  mutate(survivalProba = sum(SurvieMars, na.rm = TRUE) / n()) %>% 
  ggplot(aes(x = Size0Mars, y = SurvieMars)) +
  geom_count(alpha = 0.6) +  # Points dimensionnés selon la fréquence
  geom_point(aes(y = survivalProba), color = "red", size = 0.5) +
  geom_line(aes(y = survivalProba), color = "red") +
  labs(title = "Relation entre la survie et la taille",
       x = "Taille",
       y = "Survie",
       subtitles = "Points gris: survie réelle des individus (0 ou 1)
Points rouge: survie moyenne par classe de taille") +
  ylim(0, 1) +
  theme_minimal()

survdata %>%
  group_by(age0) %>%
  mutate(survivalProba = sum(SurvieMars, na.rm = TRUE) / n()) %>%
  ggplot(aes(x = age0, y = SurvieMars)) +
  geom_count(alpha = 0.6) +  # Points dimensionnés selon la fréquence
  geom_point(aes(x = age0, y = survivalProba), color = "red", size = 1) +
  geom_line(aes(x = age0, y = survivalProba), color = "red") +
  labs(title = "Relation entre la survie et l'age",
       x = "age",
       y = "Survie",
       subtitles = "Points gris: survie réelle des individus (0 ou 1)
Points rouge: survie moyenne par classe d'age") +
  ylim(0, 1) +
  theme_minimal()
```


### Age 1 - Plantules

Pour la survie des plantules, les effets explorés sont :

fixe : taille (polynomes et splines)

aléatoire : population, année (effet sur l'intercept ou la taille) 

```{r,echo=FALSE,warning=FALSE,out.width="50%"}
survdata1 <- survdata[survdata$age0==1,]

survdata1 %>%
  group_by(Size0Mars) %>%
  mutate(survivalProba = sum(SurvieMars, na.rm = TRUE) / n()) %>% 
  ggplot(aes(x = Size0Mars, y = SurvieMars)) +
  geom_count(alpha = 0.6) +  # Points dimensionnés selon la fréquence
  geom_point(aes(y = survivalProba), color = "red", size = 0.5) +
  geom_line(aes(y = survivalProba), color = "red") +
  labs(title = "Relation entre la survie des plantules et la taille",
       x = "Taille",
       y = "Survie",
       subtitles = "Points gris: survie réelle des individus (0 ou 1)
Points rouge: survie moyenne par classe d'age") +
  ylim(0, 1) +
  theme_minimal()
```


### Age +2 - Rosettes

Pour la survie des rosettes, les effets explorés sont :

fixe : taille (polynomes et splines) et age (polynome et splines)

aléatoire : population, année (effet sur l'intercept ou la taille), hétérogénéité individuelle (intercept)

```{r,echo=FALSE, out.width="50%",warning=FALSE}
survdata2 <- survdata[survdata$age0>1,]

survdata2 %>%
  group_by(Size0Mars) %>%
  mutate(survivalProba = sum(SurvieMars, na.rm = TRUE) / n()) %>% 
  ggplot(aes(x = Size0Mars, y = SurvieMars)) +
  geom_count(alpha = 0.6) +  # Points dimensionnés selon la fréquence
  geom_point(aes(y = survivalProba), color = "red", size = 0.5) +
  geom_line(aes(y = survivalProba), color = "red") +
  labs(title = "Relation entre la survie des rosettes et la taille",
       x = "Taille",
       y = "Survie",
       subtitles = "Points gris: survie réelle des individus (0 ou 1)
Points rouge: survie moyenne par classe de taille") +
  ylim(0, 1) +
  theme_minimal()

survdata2 %>%
  group_by(age0) %>%
  mutate(survivalProba = sum(SurvieMars, na.rm = TRUE) / n()) %>% 
  ggplot(aes(x = age0, y = SurvieMars)) +
  geom_count(alpha = 0.6) +  # Points dimensionnés selon la fréquence
  geom_point(aes(y = survivalProba), color = "red", size = 0.5) +
  geom_line(aes(y = survivalProba), color = "red") +
  labs(title = "Relation entre la survie des rosettes et l'age",
       x = "Age",
       y = "Survie",
       subtitles = "Points gris: survie réelle des individus (0 ou 1)
Points rouge: survie moyenne par classe d'age") +
  ylim(0, 1) +
  theme_minimal()
```


## Flowering Probability

On utilise un modèle binomial pour fit les données de floraison (0 ou 1).

Pour les modèles de floraison, les possibilités de combinaisons d'effets fixes et aléatoires ont été réduit pour simplifier les calculs de sélection.

Les effets d'hétérogénéité entre individus ont été retirés par soucis de temps de calcul et de convergence des modèles.

Les effets fixes de l'age ont été simplifiés en retirant les splines.

D'autres combinaisons (notamment contenant les splines de la taille) ont été retirés par un algorithme détectant si le modèle subit des effets de séparation qui empêchent la convergence du modèle.

```{r,echo=FALSE,out.width="50%"}
centauree_data %>%
  group_by(Size0Mars) %>%
  mutate(floweringProba = sum(Flowering0, na.rm = TRUE) / n()) %>% 
  ggplot(aes(x = Size0Mars, y = Flowering0)) +
  geom_count(alpha = 0.6) +  
  geom_point(aes(y = floweringProba), color = "red", size = 0.5) +
  labs(title = "Relation entre la floraison et la taille ",
    x = "Taille",
    y = "Floraison",
    subtitles = "Points gris: floraison réelle des individus (0 ou 1)
Points rouge: floraison moyenne par classe de taille") +
  ylim(0, 1) +
  theme_minimal()

centauree_data %>%
  group_by(age0) %>%
  mutate(floweringProba = sum(Flowering0, na.rm = TRUE) / n()) %>% 
  ggplot(aes(x = age0, y = Flowering0)) +
  geom_count(alpha = 0.6) +  
  geom_point(aes(y = floweringProba), color = "red", size = 0.5) +
  geom_line(aes(y = floweringProba), color = "red") +
  labs(title = "Relation entre la floraison et l'age",
    x = "age",
    y = "Floraison",
    subtitles = "Points gris: floraison réelle des individus (0 ou 1)
Points rouge: floraison moyenne par classe d'age") +
  ylim(0, 1) +
  theme_minimal()
```



## Seedl Size 

Pour fit les données de taille de plantules, on utilise un modèle qui suit une distribution log-Gamma. 

On y fait varier les effets aléatoires années, population et l'intéraction année:population.

```{r,echo=FALSE,out.width="50%"}
plantule_data <- centauree_data[centauree_data$age0==1,]

# Taille des plantules / année

plantule_data %>% 
  ggplot(aes(x = year, y = Size0Mars)) +
  geom_count(alpha=0.6) +
  labs(title = "Distribution des tailles de plantules selon les années",
    x = "Année",
    y = "Taille des plantules") +
  theme_minimal()

# Taille des plantules / population

plantule_data %>% 
  ggplot(aes(x = Pop, y = Size0Mars)) +
  geom_count(alpha=0.6) +
  labs(title = "Distribution des tailles de plantules selon les populations",
    x = "Population",
       y = "Taille des plantules") +
  theme_minimal()

plantule_data %>% 
  ggplot(aes(x=Size0Mars))+
  geom_histogram()+
  xlim(0,8)
```


## Growth

Pour la croissance des plantes, on a choisi de fit le log de la taille à l'année $t+1$ en fonction des effets fixes log de la taille à l'année $t$ et age, et des effets aléatoires population, année et hétérogénéité individuelle.

La taille à l'année $t+1$ suit une distribution logNormale.

```{r,echo=FALSE,out.width="50%"}
growthdata <- centauree_data[!is.na(centauree_data$Size1Mars), ]
growthdata <- growthdata[growthdata$Size1Mars != 0, ]

growthdata %>%
  ggplot(aes(y = Size1Mars, x = Size0Mars)) +
  geom_count(alpha=0.5) +
  labs(title = "Relation entre la taille à l'année suivante et la taille à l'année actuelle",
       y = "Taille à t+1",
       x = "Taille à t") +
  theme_minimal()

growthdata %>%
  ggplot(aes(y = log(Size1Mars), x = Size0Mars)) +
  geom_count(alpha=0.5) +
  labs(title = "Relation log-log entre la taille à l'année suivante et la taille à l'année actuelle",
       y = "log Taille à t+1",
       x = "Taille à t") +
  theme_minimal()

growthdata %>%
  ggplot(aes(y = (sqrt(Size1Mars)-1)/0.5, x = Size0Mars)) +
  geom_count(alpha=0.5) +
  labs(title = "Relation entre la taille à l'année suivante et la taille à l'année actuelle",
       y = "racine Taille à t+1",
       x = "Taille à t") +
  theme_minimal()

growthdata %>%
  ggplot(aes(y = sqrt(Size1Mars), x = Size0Mars)) +
  geom_count(alpha=0.5) +
  labs(title = "Relation entre la taille à l'année suivante et la taille à l'année actuelle",
       y = "racine Taille à t+1",
       x = "Taille à t") +
  theme_minimal()
```

```{r}
qplot(growthdata$Size1Mars)
qplot((growthdata$Size1Mars**0.5 - 1)/0.5)
qplot(growthdata$Size1Mars**0.5)
qplot(log(growthdata$Size1Mars))

```


## Fecondity

```{r,echo=FALSE,out.width="50%"}
cptldata <- centauree_data[!is.na(centauree_data$Cptl0),]
cptldata <- cptldata[!cptldata$Flowering0==0,]

# Nombre de capitule / taille 
cptldata %>% 
  
  ggplot(aes(x=Size0Mars,y=Cptl0))+
  geom_point() +
  labs(title = "Relation entre le nombre de capitules et la taille",
       x = "Taille",
       y = "Nombre de capitules") +
  theme_minimal()

# Nombre de capitule / année 
cptldata %>% 
  
  ggplot(aes(x=year,y=Cptl0))+
  geom_point() +
  labs(title = "Relation entre le nombre de capitules et l'année",
       x = "Année",
       y = "Nombre de capitules") +
  theme_minimal()
```


# Modèles par AIC

```{r}
Survglm11 <- fitme(SurvieMars ~ 1 + poly(Size0Mars,3) + 
                                  (Size0Mars|year) + (1|Pop),
                  family=binomial,
                  data=survdata1,
                  method="PQL/L")
extractAIC(Survglm11)

Survglm12 <- fitme(SurvieMars ~ 1 + bs(Size0Mars,df=4,degree=2) +(bs(age0,degree=3,knots=6.5)) + 
                                  (age0|year) + (1|Pop),
                  family=binomial,
                  data=survdata2,
                  method="PQL/L")
extractAIC(Survglm12)

Flowglm1 <- fitme(Flowering0 ~  1 + poly(Size0Mars,3) + poly(age0,2) + 
                    (age0|Pop),
                 family=binomial,
                 data=centauree_data, method="PQL/L")
extractAIC(Flowglm1)

Pltglm1 <- fitme(Size0Mars ~ 1 + (1|year) + (1|Pop) + (1|Pop:year), 
                 data=plantule_data,
                 family = Gamma(log))
extractAIC(Pltglm1)

Growthglm1 <- fitme(log(Size1Mars) ~ 1 + poly(log(Size0Mars),4) + poly(age0,3) + 
                      (log(Size0Mars)|year) + (log(Size0Mars)|Pop),
                    data=growthdata)

extractAIC(Growthglm1)

Growthglm12 <- fitme(log(Size1Mars) ~ 1 + 
                      poly(Size0Mars,3) + poly(age0,3) + 
                      (Size0Mars+age0|year) + (Size0Mars|Pop),
                    data=growthdata, resid.model = ~log(Size0Mars))
extractAIC(Growthglm12)

Growthglm2 <- fitme(Size1Mars ~ 1 +
                      bs(Size0Mars,degree=3,df=5) + bs(age0,degree=2,knots=6.5) +
                      (Size0Mars+age0|year) + (Size0Mars|Pop),
                    resid.model = ~ log(Size0Mars),
                    data=growthdata)

Cptlglm1 <- fitme(log(Cptl0) ~ 1 + Size0Mars + (age0|year), 
                  data=cptldata)
extractAIC(Cptlglm1)
```


```{r,include=FALSE}
summary(Survglm11)
summary(Survglm12)
summary(Flowglm1)
summary(Pltglm1)
summary(Cptlglm1)
summary(Growthglm1)
```

```{r}
# Growth
# sizet+1 ~ size t

res <- resid(Growthglm2)/sqrt(1.0462608+0.5367287*log(predict(Growthglm2)))
plot(fitted(Growthglm2),res);abline(0,0)

qqnorm(res);qqline(res,col="red")

plot(density(res))

summary(res)
```

```{r}
# Growth
# log
res <- resid(Growthglm1)
plot(fitted(Growthglm1),res);abline(0,0)

qqnorm(res);qqline(res,col="red")

plot(density(res))

summary(res)

res <- resid(Growthglm12)/(-0.8872301-0.4646620*log(predict(Growthglm12)))
plot(predict(Growthglm12),res);abline(0,0)

qqnorm(res);qqline(res,col="red")

plot(density(res))

summary(res)
```

```{r}
model <- Cptlglm1
res <- resid(model)
plot(exp(predict(model)),res);abline(0,0)

qqnorm(res);qqline(res,col="red")

plot(density(res))

summary(res)
```


```{r}
library(SplinesUtils)

#Pour un exemple :
# RegModel <- fitme(SurvieMars ~ 1 + bs(Size0Mars, df = 4, degree = 2) +(bs(age0, degree = 3, knots = 6.5)) + (age0|year) + (1|Pop),
#                   family=binomial,
#                   data=survdata2,
#                   method="PQL/L")
# SplineTerm <- "bs(Size0Mars, df = 4, degree = 2)"

# La fonction d'origine est RegSplineAsPiecePoly

SplinesAsPolySpaMM <- function (RegModel, SplineTerm, shift = TRUE) {
  
  #Extrait les données du spline (position dans les effets fixes, degrés des polynomes, knots)
  RegSpline <- SplinesUtils:::ExtractSplineTerm(terms(RegModel), SplineTerm)
  pos <- RegSpline$pos
  
  #Permet de sortir les coefficients de chaque bout de splines

  ind0 <- attr(RegModel$X.pv, "namesOri") #Noms des coefficients
  ind <- integer(0)
  pattern <- paste0("^", gsub("\\(", "\\\\(", gsub("\\)", "\\\\)", SplineTerm)), "\\d+$") 
  #C'est pas très propre mais pas le choix car les noms des bouts de splines finissent avec un indice 1,2,...
  ind <- grep(pattern, ind0) #Détecte si le nom du coefficient correspond au spline voulu
  RegSplineCoef <- RegModel$fixef[ind] #Sort l'estimation des coeffs
  
  RegSplineCoef <- unname(RegSplineCoef)
  na <- is.na(RegSplineCoef)
  if (any(na)) {
    warning("NA coefficients found for SplineTerm; Replacing NA by 0")
    RegSplineCoef[na] <- 0
  }
  
  #Recalcule le polynome avec la méthode d'origine, je n'y ai pas touché
  PiecePolyCoef <- SplinesUtils:::PiecePolyRepara(RegSpline, RegSplineCoef, shift)
  structure(list(
    PiecePoly = list(coef = PiecePolyCoef, shift = shift),
    knots = RegSpline$knots),
  class = c("PiecePoly", "RegSpline"))
}
```

```{r}
SplinesAsPolySpaMM(Survglm12,"bs(Size0Mars, df = 4, degree = 2)")

SplinesAsPolySpaMM(Growthglm2,"bs(Size0Mars, degree = 3, df = 5)")
SplinesAsPolySpaMM(Growthglm2,"bs(age0, degree = 2, knots = 6.5)")

f <- function(x){
  return((2.56e-16 + 1.28 * (x - 0.5) - 0.142 * (x - 0.5) ^ 2)*I(x<3)+(2.31 + 0.569 * (x - 3) - 0.0708 * (x - 3) ^ 2)*I(x>=3 & x<6)+(3.38 + 0.144 * (x - 6) - 0.00504 * (x - 6) ^ 2)*I(x>=6))
}
```


## Détails des modèles 

### Survie des plantules

$$logit(s_1(x))=\beta_0+b_{0,pop}+b_{0,year}+(\beta_1+b_{1,pop})x+\beta_2x^2+\beta_3x^3$$

$$logit(s_1(x))=-1.51+b_{0,pop}+b_{0,year}+(36.02+b_{1,pop})x+12.04x^2+29.46x^3$$

avec :

$x$ : taille au temps t

$\beta_i$, $i\in\{0,1,2,3\}$:  : coefficients du polynome de la taille

$b_{0,pop} \sim \mathcal{N}(0,0.89)$ : contribution de l'effet aléatoire Population sur l'intercept

$b_{j,year}$, $j\in\{0,1\}$: contribution de l'effet aléatoire Année sur l'intercept et la taille
$(b_{0,year},b_{1,year}) \sim \mathcal{N}(0,\Sigma)$ with 
$$\Sigma =
  \left[ {\begin{array}{cc}
    1.57 & -0.08 \\
    -0.08 & 0.066 \\
  \end{array} } \right]$$


Correlation term: $\rho=-0.78$

### Survie des rosettes

$$logit(s_a(x))=s_1(x)+s_2(a)$$
$$f_1(x) = \left\{
    \begin{array}{ll}
        b_{0,pop}+b_{0,year}+1.28(x-0.5)-(0.142+b_{0,year})(x - 0.5) ^ 2 & \mbox{si } x \leq 2 \\
        b_{0,pop}+b_{0,year}+2.31+(0.569+b_{0,year})(x-3)-0.0708(x-3)^2 & \mbox{si } x \in [2;6] \\
        b_{0,pop}+b_{0,year}+3.38 + (0.144+b_{0,year})(x - 6)-0.00504(x-6)^2 & \mbox{si } x \geq 6
    \end{array}
\right.$$

$$f_2(a) = \left\{
    \begin{array}{ll}
        b_{0,pop}+0.612 (a-2) - 0.416 (a-2)^2 + 0.0617 (a-2)^3 & \mbox{si } a \leq 6.5 \\
        b_{0,pop}-0.0382 + 0.621 (a-6.5)+0.418(a-6.5)^2 -0.844(a-6.5)^3 & \mbox{si } x \geq 6.5 \\
    \end{array}
\right.$$

avec :

$x$ : taille au temps $t$

$a$ : age au temps $t$


$b_{0,pop} \sim \mathcal{N}(0,0.073)$ : contribution de l'effet aléatoire Population sur l'intercept

$b_{j,year}$, $j\in\{0,1\}$: contribution de l'effet aléatoire Année sur l'intercept et l'age
$(b_{0,year},b_{1,year}) \sim \mathcal{N}(0,\Sigma)$ with $$\Sigma =
  \left[ {\begin{array}{cc}
    1.39 & -0.01 \\
    -0.01 & 0.0097 \\
  \end{array} } \right]$$
  
  Correlation term:
$\rho=-0.91$

### Floraison

$$logit(f_a(x))=\beta_0+b_{0,pop}+\beta_{1,1}x+\beta_{1,2}x^2+\beta_{1,3}x^3+(\beta_{2,1}+b_{1,pop})a+\beta_{2,2}a^2$$

$$logit(f_a(x))=11.49+b_{0,pop}+258.56x-86.88x^2+42.73x^3+(148.26+b_{1,pop})a-57.46a^2$$
avec :

$a$ : age au temps $t$

$x$ : taille au temps $t$

$\beta_0$ : intercept des effets fixes

$\beta_{1,i}$, $i\in\{1,2,3\}$: coefficients du polynome de la taille

$\beta_{2,i}$, $i\in\{1,2\}$: coefficients du polynome de l'age

$b_{0,pop}$ : contribution de l'effet aléatoire Population sur l'intercept

$b_{1,pop}$ : contribution de l'effet aléatoire Population sur l'age

$(b_{0,pop},b_{1,pop}) \sim \mathcal{N}(0,\Sigma)$ with $$\Sigma =
  \left[ {\begin{array}{cc}
    2.17 & -0.19 \\
    -0.19 & 0.09 \\
  \end{array} } \right]$$
  
    Correlation term:
$\rho=-0.98$


### Taille des plantules


$$y\sim\text{Gamma}(\mu,\sigma)$$
avec $\mu=\exp(\beta_0+\gamma_0+\varepsilon_0+\delta_0)$ et $\sigma=phi\times\mu^2=0.32$

$y$ : taille de la plantule

$\beta_0=0.21$, 

$\gamma_0\sim\mathcal{N}(0,0.022)$ : effet année

$\varepsilon_0\sim\mathcal{N}(0,0.026)$ : effet population

$\delta_0\sim\mathcal{N}(0,0.079)$ : effet d'intéraction population:année

Residual variation : $\phi=0.26$



### Croissance

#### log-log

$$y\sim \mathcal{N}(\mu(x,a),\sigma(x))$$

avec $\mu(x,a)=\beta_0+b_{0,1}+b_{0,2}+(\beta_{1,1}+b_{1,1}+b_{1,2})x+\beta_{2,1}x^2+\beta_{3,1}x^3+\beta_{4,1}x^4+\beta_{2,1}a+\beta_{2,2}a^2+\beta_{3,2}a^3$
$\sigma(x)=-0.9 -0.45 \log(x)$

#### 1-1

$$\mu(x,a)=\mu_1(x)+\mu_2(a)$$
$$\mu_1(x) = \left\{
    \begin{array}{ll}
        b_{0,1,year}+b_{0,pop} + (0.257+b_{1,1,year}+b_{1,pop})(x-0.5) + 0.609(x-0.5)^2 - 0.135(x-0.5)^3 & \mbox{si } x \leq 2 \\
         b_{0,1,year}+b_{0,pop}+1.3 + (1.17+b_{1,1,year}+b_{1,pop})(x-2) + 0.000897(x-2)^2 - 0.00156(x-2)^3 & \mbox{si } x \in [2;5] \\
         b_{0,1,year}+b_{0,pop}+4.78 + (1.14+b_{1,1,year}+b_{1,pop})(x-5) - 0.0131(x-5)^2 - 0.00182(x-5)^3 & \mbox{si } x \geq 5
    \end{array}
\right.$$

$$\mu_2(a) = \left\{
    \begin{array}{ll}
        - 0.768 (x - 1) + 0.104(x - 1) ^ 2 & \mbox{si } a \leq 6.5 \\
        -1.07 + 0.379(x - 6.5) - 0.661(x - 6.5) ^ 2 & \mbox{si } x \geq 6.5 \\
    \end{array}
\right.$$

$K_{year} \sim \mathcal{N}(0,\Sigma)$ with $$\Sigma_{year} =
  \left[ {\begin{array}{ccc}
    0.34 & 0.29 & -0.74 \\
    0.29 & 0.35 & -0.42 \\
    -0.74 & -0.42 & 0.042 \\
  \end{array} } \right]$$
  
  $K_{Pop} \sim \mathcal{N}(0,\Sigma)$ with $$\Sigma_{Pop} =
  \left[ {\begin{array}{cc}
    0.49 & -0.49 \\
    -0.49 & 0.0041 \\
  \end{array} } \right]$$


### Fécondité (nombre de capitules)

$$C(x)=\beta_0+\beta_1x$$

$$C(x)=2.95+2.07x$$

$x$ : taille au temps $t$

$\beta_0$ : intercept

$\beta_1$: coefficients de la taille


```{r,include=FALSE}
Survpredict11 <- predict(Survglm11, newdata = fake_data1)[,1]
Survpredict12 <- predict(Survglm12, newdata = fake_data2)[,1]
Flowpredict1 <- predict(Flowglm1, newdata = fake_data)[,1]
Pltpredict1 <- predict(Pltglm1, newdata = fake_data)[,1]
Cptlpredict1 <- predict(Cptlglm1, newdata = fake_data)[,1]
Growthpredict1 <- predict(Growthglm1, newdata = fake_data)[,1]
Growthpredict2 <- predict(Growthglm2, newdata = fake_data)[,1]

```

```{r,include=FALSE}
Gyx0 <- function (y, x, a) {
  fake <- fake_data
  fake$age0 <- a #Fixe l'age
  fake$Size0Mars <- unique(x) #Fixe la taille
  sortie <- predict(Growthglm1, fake, allow.new.levels = T) #Prédit les log(taille) à t+1 possibles
  sortie2 <- aggregate(sortie, list(fake$Size0Mars), mean) #Calcule la moyenne des log(taille)t+1
  Sdev <- sd(exp(sortie))
  return(dnorm(y, mean = exp(sortie2$V1), sd = Sdev)) #Proba qu'un individu soit de taille y à t+1 sachant la moyenne et la variance
}

Gyx1 <- function (y, x, a) {
  fake <- fake_data
  fake$age0 <- a #Fixe l'age
  fake$Size0Mars <- unique(x) #Fixe la taille
  sortie <- predict(Growthglm2, fake, allow.new.levels = T) #Prédit les log(taille) à t+1 possibles
  sortie2 <- aggregate(sortie, list(fake$Size0Mars), mean) #Calcule la moyenne des log(taille)t+1
  Sdev <- sd(sortie)
  return(dnorm(y, mean = sortie2$V1, sd = Sdev)) #Proba qu'un individu soit de taille y à t+1 sachant la moyenne et la variance
}

predi_growth1 <- matrix(NA,nrow = 50, ncol = 50, dimnames = list(seq(0.5,25,0.5),seq(0.5,25,0.5)))
for (j in 1:50){
  predi_growth1[,j] <- Gyx1(y=j/2,x=seq(0.5,25,0.5),a=5)
}
# predi_growth1 <- outer(seq(0.5,25,0.5),seq(0.5,25,0.5),Gyx1,a=2)

df.predi_growth1 <- tibble(
  size0 = rep(seq(0.5, 25, 0.5), times = nrow(predi_growth1)),
  size1 = rep(seq(0.5, 25, 0.5), each = ncol(predi_growth1)),
  prob = as.vector(predi_growth1))

df.predi_growth1 %>%
  ggplot(aes(x = size0, y = size1)) +
  geom_tile(aes(fill = prob)) +
  scale_fill_viridis_c(option = "inferno",direction=-1) +
  theme_classic()+
  labs(title = "Croissance prédite",
      x = "Size(t)",
      y = "Size(t+1)",
      fill = "Proba",
      color = "Proba")

```

```{r,warning=FALSE}
resSurv1 <- get_residVar(Survglm11,newdata = fake_data1)
# 
# fake_data1 %>%
#   mutate(surv = Survpredict11,
#          var = resSurv1)%>%
#   group_by(Size0Mars) %>% 
#   mutate(var = mean(var)) %>% 
#   group_by(Size0Mars,year) %>% 
#   mutate(surv_predi = mean(surv, na.rm = TRUE)) %>%
#   ggplot(aes(x = Size0Mars, y = surv_predi)) +
#   geom_ribbon(aes(ymin=surv_predi-var,ymax=surv_predi+var))+
#   geom_line(aes(color=as.factor(year))) +
#   theme_bw()+
#   ylim(0, 1) +
#   xlim(0,9)+
#   labs(title = "Survie prédites des plantules",
#       subtitle = "Moyenne de la survie sur les années et les populations",
#       x = "Size",
#       y = "Survival probability")

```



## Plots en fonction de la taille

```{r,echo=FALSE,warning=FALSE,out.width="50%"}
#Survie plantules
resSurv1 <- get_respVar(Survglm11,newdata = fake_data1)

fake_data1 %>%
  mutate(surv = Survpredict11)%>%
  group_by(Size0Mars,year) %>% 
  mutate(surv_predi = mean(surv, na.rm = TRUE),
         .group="drop") %>%
  ggplot(aes(x = Size0Mars, y = surv_predi)) +
  geom_line(aes(color=as.factor(year))) +
  theme_bw()+
  ylim(0, 1) +
  xlim(0,9)+
  labs(title = "Survie prédites des plantules",
      subtitle = "Moyenne de la survie sur les années et les populations",
      x = "Size",
      y = "Survival probability")

#Survie rosettes

fake_data2 %>%
  mutate(surv = Survpredict12) %>%
  filter(age0==c(2,4,8)) %>% 
  group_by(Size0Mars,year,age0) %>% 
  mutate(surv_predi = mean(surv),
            .groups = "drop") %>% 
  ggplot(aes(x = Size0Mars, y = surv_predi)) +
  facet_wrap(vars(age0), labeller = as_labeller(c('2'="age2",'4'="age4",'8'="age8")))+
  geom_line(aes(color = as.factor(year))) +
  theme_bw()+
  ylim(0, 1) +
  labs(title = "Survie prédite des rosettes",
      x = "Size",
      y = "Survival probability",
      color = "Years")


# #Floraison
# resFlow <- get_predVar(Flowglm1,newdata = fake_data)
#   geom_ribbon(aes(ymin = flow_predi-resVar, ymax = flow_predi+resVar, alpha=0.08,fill=as.factor(age0)))+  

fake_data %>%
  mutate(flow_predi = Flowpredict1) %>%
  group_by(Size0Mars, age0) %>%
  summarise(flow_predi = mean(flow_predi),
            .groups = "drop") %>%
  ggplot(aes(x = Size0Mars, y = flow_predi)) +
  geom_line(aes(color = as.factor(age0))) +
  theme_bw()+
  ylim(0, 1) +
  labs(title = "Floraison prédite",
      subtitle = "Chaque courbe représente un age, une moyenne a été faite sur
      les années et les populations",
      x = "Size",
      y = "Flowering probability",
      fill = "Ages",
      color = "Ages")
  
fake_data %>%
  mutate(flow_predi = Flowpredict1)%>%
  filter(age0==c(2,4,8)) %>% 
  group_by(Size0Mars, Pop, age0) %>%
  summarise(flow_predi = mean(flow_predi),
            .groups = "drop") %>%
  ggplot(aes(x = Size0Mars, y = flow_predi)) +
  facet_wrap(vars(age0), labeller = as_labeller(c('2'="age2",'4'="age4",'8'="age8")))+
  geom_line(aes(color = as.factor(Pop))) +
  theme_bw()+
  ylim(0, 1) +
  labs(title = "Floraison prédite",
      subtitle = "Chaque courbe représente un age, une moyenne a été faite sur
      les années et les populations",
      x = "Size",
      y = "Flowering probability",
      fill = "Populations",
      color = "Populations")

#Croissance
fake_data %>%
  mutate(s1_predi = Growthpredict2) %>%
  group_by(Size0Mars, age0) %>%
  summarise(s1_predi = mean(s1_predi),
            .groups = "drop") %>%
  ggplot(aes(x = Size0Mars, y = s1_predi)) +
  geom_abline(lty="dashed")+
  geom_line(aes(color = as.factor(age0))) +
  theme_bw()+
  labs(title = "Croissance prédite",
      subtitle = "Chaque courbe représente un age, une moyenne a été faite sur les années et les populations",
      x = "Size(t)",
      y = "Size(t+1)",
      fill = "Ages",
      color = "Ages")


fake_data %>%
  mutate(s1_predi = Growthpredict2) %>%
  filter(age0==c(1,4,8)) %>% 
  group_by(Size0Mars, year, age0) %>%
  mutate(s1_predi = mean(s1_predi),
            .groups = "drop") %>%
  ggplot(aes(x = Size0Mars, y = s1_predi)) +
  facet_wrap(vars(age0), labeller = as_labeller(c('1'="age1",'4'="age4",'8'="age8")))+
  geom_line(aes(color = as.factor(year))) +
  geom_abline(lty="dashed")+
  theme_bw()+
  labs(title = "Croissance prédite",
      subtitle = "Chaque courbe représente un age, une moyenne a été faite sur les années et les populations",
      x = "Size(t)",
      y = "Size(t+1)",
      fill = "Years",
      color = "Years")+
  theme(legend.text = element_text(size = 4),
          legend.key.size = unit(0.4, "cm"),
          legend.title = element_text(size = 8))

fake_data %>%
  mutate(s1_predi = exp(Growthpredict1)) %>%
  group_by(Size0Mars, age0) %>%
  summarise(s1_predi = mean(s1_predi),
            .groups = "drop") %>%
  ggplot(aes(x = Size0Mars, y = s1_predi)) +
  geom_abline(lty="dashed")+
  geom_line(aes(color = as.factor(age0))) +
  theme_bw()+
  labs(title = "Croissance prédite (log-log)",
      subtitle = "Chaque courbe représente un age, une moyenne a été faite sur les années et les populations",
      x = "Size(t)",
      y = "Size(t+1)",
      fill = "Ages",
      color = "Ages")

fake_data %>%
  mutate(s1_predi = exp(Growthpredict1)) %>%
  filter(age0==c(1,4,8)) %>% 
  group_by(Size0Mars, year, age0) %>%
  mutate(s1_predi = mean(s1_predi),
            .groups = "drop") %>%
  ggplot(aes(x = Size0Mars, y = s1_predi)) +
  facet_wrap(vars(age0), labeller = as_labeller(c('1'="age1",'4'="age4",'8'="age8")))+
  geom_line(aes(color = as.factor(year))) +
  geom_abline(lty="dashed")+
  theme_bw()+
  labs(title = "Croissance prédite (log-log)",
      subtitle = "Chaque courbe représente un age, une moyenne a été faite sur les années et les populations",
      x = "Size(t)",
      y = "Size(t+1)",
      fill = "Years",
      color = "Years")+
  theme(legend.text = element_text(size = 4),
          legend.key.size = unit(0.4, "cm"),
          legend.title = element_text(size = 8))

#Fécondité
fake_data %>%
  mutate(cptl_predi = exp(Cptlpredict1)) %>%
  group_by(Size0Mars,year) %>% 
  summarise(cptl_predi = mean(cptl_predi)) %>% 
  ggplot(aes(x = Size0Mars, y = cptl_predi)) +
  geom_point(data = cptldata, aes(y = Cptl0), alpha = 0.6) +
  geom_line(aes(color=as.factor(year))) +
  theme_bw()+
  labs(title = "Nombre de capitules prédit",
    x = "Size",
    y = "Nbr. of capitula")
```

On voit clairement que la probabilité de survie augmente quand la plante grandit, jusqu'à atteindre un plateau pour les rosettes.
La survie d'une plante de petite taille est assez basse, peu importe qu'elle soit d'age 1 ou plus. 
On ne peut pas vraiment conclure sur la survie des plantules de grande taille (>5) du fait de la très faible quantité de données pour ces classes de tailles (27 observations).

On voit que la probabilité de floraison augmente fortement avec la taille.
De même que pour la survie, on ne peut rien dire de la floraison des plantules de grandes tailles.


Plot de la croissance à côté de la floraison
```{r}
fake_data %>%
  mutate(s1_predi = exp(Growthpredict1),
         flow_predi = Flowpredict1) %>%
  group_by(Size0Mars) %>% 
  mutate(flow_predi = mean(flow_predi)) %>% 
  group_by(Size0Mars, age0) %>%
  mutate(s1_predi = mean(s1_predi),
            .groups = "drop") %>%
  ggplot(aes(x = Size0Mars, y = s1_predi)) +
  geom_abline(lty="dashed")+
  geom_line(aes(y = 17.5*flow_predi),color="red") +
    scale_y_continuous("Size(t+1)", 
    sec.axis = sec_axis(~ . /17.5, name = "Flowering Probability"))+
  geom_line(aes(color = as.factor(age0))) +
  theme_bw()+
  labs(title = "Croissance prédite (log-log)",
      subtitle = "Chaque courbe représente un age, une moyenne a été faite sur les années et les populations",
      x = "Size(t)",
      y = "Size(t+1)",
      fill = "Ages",
      color = "Ages")


fake_data %>%
  mutate(s1_predi = exp(Growthpredict1),
         flow_predi = Flowpredict1) %>%
  group_by(Size0Mars, age0) %>%
  mutate(s1_predi = mean(s1_predi),
         flow_predi = mean(flow_predi),
            .groups = "drop") %>%
  ggplot(aes(x = Size0Mars, y = s1_predi)) +
  geom_abline(lty="dashed")+
  geom_line(aes(y = 17.5*flow_predi, color = as.factor(age0))) +
    scale_y_continuous("Size(t+1)", 
    sec.axis = sec_axis(~ . /17.5, name = "Flowering Probability"))+
  geom_line(aes(color = as.factor(age0))) +
  theme_bw()+
  labs(title = "Croissance prédite (log-log)",
      subtitle = "Chaque courbe représente un age, une moyenne a été faite sur les années et les populations",
      x = "Size(t)",
      y = "Size(t+1)",
      fill = "Ages",
      color = "Ages")
```




### Plots en fonction de l'age

```{r,echo=FALSE,warning=FALSE,out.width="50%"}
#Survie rosettes
resSurv2 <- residVar(Survglm12,newdata = fake_data2)

fake_data2 %>%
  mutate(surv = Survpredict12,
         resSurv = resSurv2) %>%
  group_by(age0,year) %>% 
  summarise(surv_predi = mean(surv),
            res = mean(resSurv, na.rm = TRUE),
            .groups = "drop") %>% 
  ggplot(aes(x = age0, y = surv_predi)) +
  geom_ribbon(aes(ymin=surv_predi-res, ymax=surv_predi+res, fill = as.factor(year)), alpha=0.01)+
  geom_line(aes(color = as.factor(year))) +
  theme_minimal() +
  ylim(0, 1) +
  labs(title = "Survie prédite des rosettes",
      subtitle = "Chaque courbe représente une année, 
une moyenne a été faite sur les tailles et les populations",
      x = "Age",
      y = "Survival probability",
      fill = "Years",
      color = "Years")

#Floraison
resFlow <- residVar(Flowglm1,newdata = fake_data)

fake_data %>%
  mutate(flow_predi = Flowpredict1,
         resFlow = resFlow) %>%
  group_by(Pop, age0) %>%
  summarise(flow_predi = mean(flow_predi), 
            res = mean(resFlow),
            .groups = "drop") %>%
  ggplot(aes(x = age0, y = flow_predi)) +
  geom_ribbon(aes(ymin = flow_predi-res, ymax = flow_predi+res, fill = as.factor(Pop)), alpha=0.08)+
  geom_line(aes(color = as.factor(Pop))) +
  theme_minimal() +
  ylim(0, 1) +
  labs(title = "Floraison prédite",
      subtitle = "Chaque courbe représente une population, 
une moyenne a été faite sur les années et les tailles",
      x = "Age",
      y = "Flowering probability",
      fill = "Populations",
      color = "Populations")
  

#Croissance
resGrowth <- residVar(Growthglm1,newdata = fake_data)

fake_data %>%
  mutate(s1_predi = exp(Growthpredict1)/Size0Mars) %>%
  group_by(year, age0) %>%
  summarise(s_predi = mean(s1_predi),
            .groups = "drop") %>%
  ggplot(aes(x = age0, y = s_predi)) +
  geom_abline(intercept=1,slope=0,lty="dashed")+
  geom_line(aes(color = as.factor(year))) +
  theme_minimal() +
  labs(title = "Croissance prédite",
      subtitle = "Chaque courbe représente une année, 
      une moyenne a été faite sur les tailles et les populations",
      x = "Age",
      y = "Size(t+1) / Size(t)",
      fill = "Years",
      color = "Years")

fake_data %>%
  mutate(s1_predi = exp(Growthpredict1)/Size0Mars) %>%
  group_by(Pop, age0) %>%
  summarise(s_predi = mean(s1_predi),
            .groups = "drop") %>%
  ggplot(aes(x = age0, y = s_predi)) +
  geom_abline(intercept=1,slope=0,lty="dashed")+
  geom_line(aes(color = as.factor(Pop))) +
  theme_minimal() +
  labs(title = "Croissance prédite",
      subtitle = "Chaque courbe représente une population, 
      une moyenne a été faite sur les tailles et les années",
      x = "Age",
      y = "Size(t+1) / Size(t)",
      fill = "Populations",
      color = "Populations")

#Fécondité
fake_data %>%
  mutate(cptl_predi = exp(Cptlpredict1)) %>%
  group_by(year,age0) %>% 
  summarise(cptl_predi = mean(cptl_predi)) %>% 
  ggplot(aes(x = age0, y = cptl_predi)) +
  geom_point(data = cptldata, aes(y = Cptl0), alpha = 0.6) +
  geom_line(aes(color=as.factor(year))) +
  theme_bw()+
  labs(title = "Nombre de capitules prédit",
    x = "Size",
    y = "Nbr. of capitula")
```


### Autres plots

```{r,echo=FALSE,out.width="50%"}

#Taille des plantules
resPlt <- residVar(Pltglm1,newdata = fake_data)

fake_data %>%
  mutate(plt_predi = Pltpredict1,
         res = resPlt) %>%
  ggplot(aes(x = year, y = plt_predi)) +
  geom_ribbon(aes(ymin = plt_predi-res, ymax = plt_predi+res, fill = as.factor(Pop)), alpha=0.08)+
  geom_line(aes(color = as.factor(Pop))) +
  theme_minimal()+
  labs(title = "Taille des plantules prédite",
    subtitle = "Chaque courbe représente une population",
    x = "Year",
    y = "Seedling size")

hist(Pltpredict1)
```


Histoire de vie de la croissance d'une plante
```{r}
nbofind <- 100
Grow <- function (x, a) {
    fake_data <- expand.grid(
  year = annees,
  Pop = populations,
  Size0Mars = unique(x),
  age0 = a)
  mu <- predict(Growthglm2, fake_data, allow.new.levels = T, residVar=TRUE) #Prédit les log(taille) à t+1 possibles 
  mu2 <- aggregate(mu, list(fake_data$Size0Mars), mean) #Calcule la moyenne des log(taille)t+1
  usd <- sqrt(exp(1.0462608+0.5367287*log(unique(x))))
  return(rnorm(nbofind, mean = mu2$V1, sd = usd)) #Proba qu'un individu soit de taille y à t+1 sachant la moyenne et la variance
}

fake_growth <- expand.grid(
     Ind = 1:nbofind,
   year = annees[1:8],
   Size = NA)

start <- 2

fake_growth$Size[fake_growth$year==annees[1]] <- start

for (t in 2:8){
  size1 <- Grow(fake_growth$Size[fake_growth$year==annees[t-1]],t-1)
  fake_growth$Size[fake_growth$year==annees[t]] <- size1 
  fake_growth$Size <- ifelse(fake_growth$Size<0,0L,fake_growth$Size)
}

for(i in 1:nbofind){
  if (0 %in% fake_growth$Size[fake_growth$Ind==i]){
    pos <- which(fake_growth$Size[fake_growth$Ind==i]==0)
    fake_growth$Size[fake_growth$Ind==i][pos:8] <- 0
  }
}

ggplot(data = fake_growth, aes(year, y=Size))+
  geom_line(aes(color=as.factor(Ind)),show.legend = FALSE)+
  theme_bw()
```
Comparaison variance prédite et variance observé pour la croissance
```{r}
fake <- expand.grid(
  year = annees,
  Pop = populations,
  age0 = 1:8,
  Size0Mars = 1)
plot(sqrt(get_residVar(Growthglm2,newdata=fake)))
plot(sd(growthdata$Size0Mars))
```



# Modèles par BIC

```{r}
Survglm11 <- fitme(SurvieMars ~ 1+ poly(Size0Mars,3) + (1|year) + (1|Pop),
                  family=binomial,
                  data=survdata1,
                  method="PQL/L")
extractBIC(Survglm11,length(survdata1))

Survglm12 <- fitme(SurvieMars ~ 1 + bs(Size0Mars,df=3,degree=2) + (age0|year) + (1|Pop),
                  family=binomial,
                  data=survdata2,
                  method="PQL/L")
extractBIC(Survglm12,length(survdata2))

Flowglm1 <- fitme(Flowering0 ~  1 + poly(Size0Mars,3) + poly(age0,2) + (age0|Pop),
                 family=binomial,
                 data=centauree_data, method="PQL/L")
extractBIC(Flowglm1,length(centauree_data))

Growthglm1 <- fitme(log(Size1Mars) ~ 1 + poly(log(Size0Mars),3) + poly(age0,3) + (log(Size0Mars)|year) + (log(Size0Mars)|Pop),
                    data=growthdata)
extractBIC(Growthglm1,length(growthdata))

Pltglm1 <- fitme(Size0Mars ~ 1 + (1|year) + (1|Pop) + (1|Pop:year),
                 data=plantule_data,
                 family = Gamma(log))
extractBIC(Pltglm1,length(plantule_data))

Cptlglm1 <- fitme(Cptl0 ~ 1 + Size0Mars,
                  data = cptldata)
extractBIC(Cptlglm1,length(cptldata))
```

```{r,include=FALSE}
Survpredict11 <- predict(Survglm11, newdata = fake_data1)[,1]
Survpredict12 <- predict(Survglm12, newdata = fake_data2)[,1]
Flowpredict1 <- predict(Flowglm1, newdata = fake_data)[,1]
Pltpredict1 <- predict(Pltglm1, newdata = fake_data)[,1]
Cptlpredict1 <- predict(Cptlglm1, newdata = fake_data)[,1]
Growthpredict1 <- predict(Growthglm1, newdata = fake_data)[,1]
```

## Plots en fonction de la taille

```{r,echo=FALSE,warning=FALSE,out.width="50%"}
maxdat <- max(survdata1$Size0Mars)
mindat <- min(survdata1$Size0Mars)

#Survie plantules
resSurv1 <- residVar(Survglm11,newdata = fake_data1)

fake_data1 %>%
  mutate(surv = Survpredict11,
         resSurv = resSurv1) %>%
  group_by(Size0Mars) %>% 
  summarise(surv_predi = mean(surv, na.rm = TRUE),
            resSurv = mean(resSurv, na.rm = TRUE)) %>%
  ggplot(aes(x = Size0Mars, y = surv_predi)) +
  geom_ribbon(aes(ymin=surv_predi-resSurv, ymax=surv_predi+resSurv),fill = "red", alpha=0.08)+
  geom_line(color="red") +
  theme_minimal() +
  ylim(0, 1) +
  xlim(0,9)+
  labs(title = "Survie prédites des plantules",
      subtitle = "Moyenne de la survie sur les années et les populations",
      x = "Taille",
      y = "Probabilité de survie")

#Survie rosettes
resSurv2 <- residVar(Survglm12,newdata = fake_data2)

fake_data2 %>%
  mutate(surv = Survpredict12,
         resSurv = resSurv2) %>%
  group_by(Size0Mars,age0) %>% 
  summarise(surv_predi = mean(surv),
            res = mean(resSurv, na.rm = TRUE),
            .groups = "drop") %>% 
  ggplot(aes(x = Size0Mars, y = surv_predi)) +
  geom_ribbon(aes(ymin=surv_predi-res, ymax=surv_predi+res, fill = as.factor(age0)), alpha=0.08)+
  geom_line(aes(color = as.factor(age0))) +
  theme_minimal() +
  ylim(0, 1) +
  labs(title = "Survie prédite des rosettes",
      subtitle = "Chaque courbe représente un age, une moyenne a été faite sur
      les années et les populations",
      x = "Taille",
      y = "Probabilité de survie",
      fill = "Ages",
      color = "Ages")

#Floraison
resFlow <- residVar(Flowglm1,newdata = fake_data)

fake_data %>%
  mutate(flow_predi = Flowpredict1,
         resFlow = resFlow) %>%
  group_by(Size0Mars, age0) %>%
  summarise(flow_predi = mean(flow_predi), 
            res = mean(resFlow),
            .groups = "drop") %>%
  ggplot(aes(x = Size0Mars, y = flow_predi)) +
  geom_ribbon(aes(ymin = flow_predi-res, ymax = flow_predi+res, fill = as.factor(age0)), alpha=0.08)+
  geom_line(aes(color = as.factor(age0))) +
  theme_minimal() +
  ylim(0, 1) +
  labs(title = "Floraison prédite",
      subtitle = "Chaque courbe représente un age, une moyenne a été faite sur
      les années et les populations",
      x = "Taille",
      y = "Probabilité de floraison",
      fill = "Ages",
      color = "Ages")
  

#Croissance
resGrowth <- residVar(Growthglm1,newdata = fake_data)

fake_data %>%
  mutate(s1_predi = exp(Growthpredict1),
         resGrowth = resGrowth) %>%
  group_by(Size0Mars, age0) %>%
  summarise(s1_predi = mean(s1_predi), 
            res = mean(resGrowth),
            .groups = "drop") %>%
  ggplot(aes(x = Size0Mars, y = s1_predi)) +
  geom_abline(lty="dashed")+
  geom_ribbon(aes(ymin = s1_predi-res, ymax = s1_predi+res, fill = as.factor(age0)), alpha=0.08)+
  geom_line(aes(color = as.factor(age0))) +
  theme_minimal() +
  labs(title = "Croissance prédite",
      subtitle = "Chaque courbe représente un age, une moyenne a été faite sur les années et les populations",
      x = "Taille à t",
      y = "Taille à t+1",
      fill = "Ages",
      color = "Ages")

#Fécondité
fake_data %>%
  mutate(cptl_predi = Cptlpredict1) %>%
  group_by(Size0Mars) %>% 
  summarise(cptl_predi = mean(cptl_predi)) %>% 
  ggplot(aes(x = Size0Mars, y = cptl_predi)) +
  geom_point(data = cptldata, aes(y = Cptl0), alpha = 0.6) +
  geom_line(color="red") +
  theme_minimal() +
  labs(title = "Nombre de capitules prédit",
    subtitle = "r² = 0.2027",
    x = "Taille",
    y = "Nombre de capitules")
```

Les modèle choisis par BIC sont globalement similaires que pour ceux choisis par AIC.
On constate quand même des différences pour la survie des rosettes et pour la croissance.
Pour la survie des rosettes, le modèle choisi propose une diminution de la survie pour les plantes de grande taille. Cette incertitude avec le modèle AIC correspond avec l'incertitude qu'on a pour ces classes de taille qui comportent peu de données.
Pour la croissance, l'effet de réduction de la croissance pour les plantes de grande taille se retrouve dans les deux modèles (AIC et BIC), cependant cet effet est moins fort pour le modèle BIC.

### Plots en fonction de l'age

```{r,echo=FALSE,warning=FALSE,out.width="50%"}
#Survie rosettes
resSurv2 <- residVar(Survglm12,newdata = fake_data2)

fake_data2 %>%
  mutate(surv = Survpredict12,
         resSurv = resSurv2) %>%
  group_by(age0,year) %>% 
  summarise(surv_predi = mean(surv),
            res = mean(resSurv, na.rm = TRUE),
            .groups = "drop") %>% 
  ggplot(aes(x = age0, y = surv_predi)) +
  geom_ribbon(aes(ymin=surv_predi-res, ymax=surv_predi+res, fill = as.factor(year)), alpha=0.01)+
  geom_line(aes(color = as.factor(year))) +
  theme_minimal() +
  ylim(0, 1) +
  labs(title = "Survie prédite des rosettes",
      subtitle = "Chaque courbe représente une année, 
une moyenne a été faite sur les tailles et les populations",
      x = "Ages",
      y = "Probabilité de survie",
      fill = "Années",
      color = "Années")

#Floraison
resFlow <- residVar(Flowglm1,newdata = fake_data)

fake_data %>%
  mutate(flow_predi = Flowpredict1,
         resFlow = resFlow) %>%
  group_by(Pop, age0) %>%
  summarise(flow_predi = mean(flow_predi), 
            res = mean(resFlow),
            .groups = "drop") %>%
  ggplot(aes(x = age0, y = flow_predi)) +
  geom_ribbon(aes(ymin = flow_predi-res, ymax = flow_predi+res, fill = as.factor(Pop)), alpha=0.08)+
  geom_line(aes(color = as.factor(Pop))) +
  theme_minimal() +
  ylim(0, 1) +
  labs(title = "Floraison prédite",
      subtitle = "Chaque courbe représente une population, 
une moyenne a été faite sur les années et les tailles",
      x = "Age",
      y = "Probabilité de floraison",
      fill = "Populations",
      color = "Populations")
  

#Croissance
resGrowth <- residVar(Growthglm1,newdata = fake_data)

fake_data %>%
  mutate(s1_predi = exp(Growthpredict1)/Size0Mars) %>%
  group_by(year, age0) %>%
  summarise(s_predi = mean(s1_predi),
            .groups = "drop") %>%
  ggplot(aes(x = age0, y = s_predi)) +
  geom_abline(intercept=1,slope=0,lty="dashed")+
  geom_line(aes(color = as.factor(year))) +
  theme_minimal() +
  labs(title = "Croissance prédite",
      subtitle = "Chaque courbe représente une année, 
      une moyenne a été faite sur les tailles et les populations",
      x = "Age",
      y = "Taille à t+1 / Taille à t",
      fill = "Années",
      color = "Années")

fake_data %>%
  mutate(s1_predi = exp(Growthpredict1)/Size0Mars) %>%
  group_by(Pop, age0) %>%
  summarise(s_predi = mean(s1_predi),
            .groups = "drop") %>%
  ggplot(aes(x = age0, y = s_predi)) +
  geom_abline(intercept=1,slope=0,lty="dashed")+
  geom_line(aes(color = as.factor(Pop))) +
  theme_minimal() +
  labs(title = "Croissance prédite",
      subtitle = "Chaque courbe représente une population, 
      une moyenne a été faite sur les tailles et les années",
      x = "Age",
      y = "Taille à t+1 / Taille à t",
      fill = "Populations",
      color = "Populations")
```

La sélection par le BIC réduit le nombre de variables explicatives. On peut le voir notamment pour la survie des rosettes en fonction de l'age. Le modèle BIC ne choisit pas une fonction de survie qui dépend de l'age, il y a seulement un effet aléatoire de l'age sur l'année.


### Autres plots

```{r,echo=FALSE,out.width="50%"}

#Taille des plantules
resPlt <- residVar(Pltglm1,newdata = fake_data)

fake_data %>%
  mutate(plt_predi = Pltpredict1,
         res = resPlt) %>%
  ggplot(aes(x = year, y = plt_predi)) +
  geom_ribbon(aes(ymin = plt_predi-res, ymax = plt_predi+res, fill = as.factor(Pop)), alpha=0.08)+
  geom_line(aes(color = as.factor(Pop))) +
  theme_minimal()+
  labs(title = "Taille des plantules prédite",
    subtitle = "Chaque courbe représente une population",
    x = "Année",
    y = "Taille des plantules")
```

